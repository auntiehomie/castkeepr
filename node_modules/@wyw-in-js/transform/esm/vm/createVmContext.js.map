{"version":3,"file":"createVmContext.js","names":["vm","isFeatureEnabled","process","NOOP","createWindow","Window","GlobalWindow","require","HappyWindow","win","Buffer","Uint8Array","setReferencePropertyIfNotPresent","context","key","createBaseContext","additionalContext","baseContext","document","clearImmediate","clearInterval","clearTimeout","setImmediate","requestAnimationFrame","setInterval","setTimeout","createHappyDOMWindow","teardown","happyDOM","abort","window","createNothing","undefined","createVmContext","filename","features","overrideContext","i","isHappyDOMEnabled","__filename","createContext"],"sources":["../../src/vm/createVmContext.ts"],"sourcesContent":["import * as vm from 'vm';\n\nimport type { Window } from 'happy-dom';\n\nimport type { FeatureFlags, StrictOptions } from '@wyw-in-js/shared';\nimport { isFeatureEnabled } from '@wyw-in-js/shared';\n\nimport * as process from './process';\n\nconst NOOP = () => {};\n\nfunction createWindow(): Window {\n  const { Window, GlobalWindow } = require('happy-dom');\n  const HappyWindow = GlobalWindow || Window;\n  const win = new HappyWindow();\n\n  // TODO: browser doesn't expose Buffer, but a lot of dependencies use it\n  win.Buffer = Buffer;\n  win.Uint8Array = Uint8Array;\n\n  return win;\n}\n\n/**\n * `happy-dom` already has required references, so we don't need to set them.\n */\nfunction setReferencePropertyIfNotPresent(\n  context: vm.Context,\n  key: string\n): void {\n  if (context[key] === context) {\n    return;\n  }\n\n  context[key] = context;\n}\n\nfunction createBaseContext(\n  win: Window | undefined,\n  additionalContext: Partial<vm.Context>\n): Partial<vm.Context> {\n  const baseContext: vm.Context = win ?? {};\n\n  setReferencePropertyIfNotPresent(baseContext, 'window');\n  setReferencePropertyIfNotPresent(baseContext, 'self');\n  setReferencePropertyIfNotPresent(baseContext, 'top');\n  setReferencePropertyIfNotPresent(baseContext, 'parent');\n  setReferencePropertyIfNotPresent(baseContext, 'global');\n  setReferencePropertyIfNotPresent(baseContext, 'process');\n\n  baseContext.document = win?.document;\n  baseContext.process = process;\n\n  baseContext.clearImmediate = NOOP;\n  baseContext.clearInterval = NOOP;\n  baseContext.clearTimeout = NOOP;\n  baseContext.setImmediate = NOOP;\n  baseContext.requestAnimationFrame = NOOP;\n  baseContext.setInterval = NOOP;\n  baseContext.setTimeout = NOOP;\n\n  // eslint-disable-next-line guard-for-in,no-restricted-syntax\n  for (const key in additionalContext) {\n    baseContext[key] = additionalContext[key];\n  }\n\n  return baseContext;\n}\n\nfunction createHappyDOMWindow() {\n  const win = createWindow();\n\n  return {\n    teardown: () => {\n      win.happyDOM.abort();\n    },\n    window: win,\n  };\n}\n\nfunction createNothing() {\n  return {\n    teardown: () => {},\n    window: undefined,\n  };\n}\n\nexport function createVmContext(\n  filename: string,\n  features: FeatureFlags<'happyDOM'>,\n  additionalContext: Partial<vm.Context>,\n  overrideContext: StrictOptions['overrideContext'] = (i) => i\n) {\n  const isHappyDOMEnabled = isFeatureEnabled(features, 'happyDOM', filename);\n\n  const { teardown, window } = isHappyDOMEnabled\n    ? createHappyDOMWindow()\n    : createNothing();\n  const baseContext = createBaseContext(\n    window,\n    overrideContext(\n      {\n        __filename: filename,\n        ...additionalContext,\n      },\n      filename\n    )\n  );\n\n  const context = vm.createContext(baseContext);\n\n  return {\n    context,\n    teardown,\n  };\n}\n"],"mappings":"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"}