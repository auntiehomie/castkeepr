{"version":3,"file":"Entrypoint.helpers.js","names":["readFileSync","dirname","extname","isAbsolute","logger","isFeatureEnabled","buildOptions","loadBabelOptions","getFileIdx","getPluginKey","getMatchedRule","rules","filename","code","i","length","rule","test","RegExp","action","parseFile","babel","originalCode","parseConfig","log","extend","parseResult","parseSync","Error","isModuleResolver","plugin","key","includes","moduleResolverWarned","buildConfigs","services","name","pluginOptions","babelOptions","options","commonOptions","ast","inputSourceMap","root","sourceFileName","sourceMaps","rawConfig","useBabelConfigs","features","configFile","babelrc","parseHasModuleResolver","plugins","some","rawHasModuleResolver","console","warn","filter","evalConfig","loadAndParse","loadedCode","eventEmitter","extension","extensions","evaluator","reason","getOrParse","perf","require","resolve","paths","default","getStack","entrypoint","stack","parents","push","mergeOnly","a","b","result","Set","forEach","item","add","sort","isSuperSet","aSet","every","has"],"sources":["../../src/transform/Entrypoint.helpers.ts"],"sourcesContent":["import { readFileSync } from 'fs';\nimport { dirname, extname, isAbsolute } from 'path';\n\nimport type { TransformOptions, PluginItem } from '@babel/core';\nimport type { File } from '@babel/types';\n\nimport type {\n  Debugger,\n  EvalRule,\n  Evaluator,\n  StrictOptions,\n} from '@wyw-in-js/shared';\nimport { logger, isFeatureEnabled } from '@wyw-in-js/shared';\n\nimport type { Core } from '../babel';\nimport { buildOptions } from '../options/buildOptions';\nimport { loadBabelOptions } from '../options/loadBabelOptions';\nimport type { ParentEntrypoint } from '../types';\nimport { getFileIdx } from '../utils/getFileIdx';\nimport { getPluginKey } from '../utils/getPluginKey';\n\nimport type { IEntrypointCode, IIgnoredEntrypoint } from './Entrypoint.types';\nimport type { Services } from './types';\n\nexport function getMatchedRule(\n  rules: EvalRule[],\n  filename: string,\n  code: string\n): EvalRule {\n  for (let i = rules.length - 1; i >= 0; i--) {\n    const rule = rules[i];\n    if (!rule.test) {\n      return rule;\n    }\n\n    if (typeof rule.test === 'function' && rule.test(filename, code)) {\n      return rule;\n    }\n\n    if (rule.test instanceof RegExp && rule.test.test(filename)) {\n      return rule;\n    }\n  }\n\n  return { action: 'ignore' };\n}\n\nexport function parseFile(\n  babel: Core,\n  filename: string,\n  originalCode: string,\n  parseConfig: TransformOptions\n): File {\n  const log = logger.extend('transform:parse').extend(getFileIdx(filename));\n\n  const parseResult = babel.parseSync(originalCode, parseConfig);\n  if (!parseResult) {\n    throw new Error(`Failed to parse ${filename}`);\n  }\n\n  log('stage-1', `${filename} has been parsed`);\n\n  return parseResult;\n}\n\nconst isModuleResolver = (plugin: PluginItem) => {\n  const key = getPluginKey(plugin);\n  if (!key) return false;\n\n  if (['module-resolver', 'babel-plugin-module-resolver'].includes(key)) {\n    return true;\n  }\n\n  return /([\\\\/])babel-plugin-module-resolver\\1/.test(key);\n};\n\nlet moduleResolverWarned = false;\n\nfunction buildConfigs(\n  services: Services,\n  name: string,\n  pluginOptions: StrictOptions,\n  babelOptions: TransformOptions | undefined\n): {\n  evalConfig: TransformOptions;\n  parseConfig: TransformOptions;\n} {\n  const { babel, options } = services;\n\n  const commonOptions = {\n    ast: true,\n    filename: name,\n    inputSourceMap: options.inputSourceMap,\n    root: options.root,\n    sourceFileName: name,\n    sourceMaps: true,\n  };\n\n  const rawConfig = buildOptions(\n    pluginOptions?.babelOptions,\n    babelOptions,\n    commonOptions\n  );\n\n  const useBabelConfigs = isFeatureEnabled(\n    pluginOptions.features,\n    'useBabelConfigs',\n    name\n  );\n\n  if (!useBabelConfigs) {\n    rawConfig.configFile = false;\n  }\n\n  const parseConfig = loadBabelOptions(babel, name, {\n    babelrc: useBabelConfigs,\n    ...rawConfig,\n  });\n\n  const parseHasModuleResolver = parseConfig.plugins?.some(isModuleResolver);\n  const rawHasModuleResolver = rawConfig.plugins?.some(isModuleResolver);\n\n  if (parseHasModuleResolver && !rawHasModuleResolver) {\n    if (!moduleResolverWarned) {\n      // eslint-disable-next-line no-console\n      console.warn(\n        `[wyw-in-js] ${name} has a module-resolver plugin in its babelrc, but it is not present ` +\n          `in the babelOptions for the wyw-in-js plugin. This works for now but will be an error in the future. ` +\n          `Please add the module-resolver plugin to the babelOptions for the wyw-in-js plugin.`\n      );\n\n      moduleResolverWarned = true;\n    }\n\n    rawConfig.plugins = [\n      ...(parseConfig.plugins?.filter((plugin) => isModuleResolver(plugin)) ??\n        []),\n      ...(rawConfig.plugins ?? []),\n    ];\n  }\n\n  const evalConfig = loadBabelOptions(babel, name, {\n    babelrc: false,\n    ...rawConfig,\n  });\n\n  return {\n    evalConfig,\n    parseConfig,\n  };\n}\n\nexport function loadAndParse(\n  services: Services,\n  name: string,\n  loadedCode: string | undefined,\n  log: Debugger\n): IEntrypointCode | IIgnoredEntrypoint {\n  const {\n    babel,\n    eventEmitter,\n    options: { pluginOptions },\n  } = services;\n\n  const extension = extname(name);\n\n  if (!pluginOptions.extensions.includes(extension)) {\n    log(\n      '[createEntrypoint] %s is ignored. If you want it to be processed, you should add \\'%s\\' to the \"extensions\" option.',\n      name,\n      extension\n    );\n\n    return {\n      get code() {\n        if (isAbsolute(name)) {\n          return loadedCode ?? readFileSync(name, 'utf-8');\n        }\n\n        return ''; // it is a built-in module\n      },\n      evaluator: 'ignored',\n      reason: 'extension',\n    };\n  }\n\n  const code = loadedCode ?? readFileSync(name, 'utf-8');\n\n  const { action, babelOptions } = getMatchedRule(\n    pluginOptions.rules,\n    name,\n    code\n  );\n\n  let ast: File | undefined;\n\n  const { evalConfig, parseConfig } = buildConfigs(\n    services,\n    name,\n    pluginOptions,\n    babelOptions\n  );\n\n  const getOrParse = () => {\n    if (ast) return ast;\n    ast = eventEmitter.perf('parseFile', () =>\n      parseFile(babel, name, code, parseConfig)\n    );\n\n    return ast;\n  };\n\n  if (action === 'ignore') {\n    log('[createEntrypoint] %s is ignored by rule', name);\n    return {\n      get ast() {\n        return getOrParse();\n      },\n      code,\n      evaluator: 'ignored',\n      reason: 'rule',\n    };\n  }\n\n  const evaluator: Evaluator =\n    typeof action === 'function'\n      ? action\n      : require(\n          require.resolve(action, {\n            paths: [dirname(name)],\n          })\n        ).default;\n\n  return {\n    get ast() {\n      return getOrParse();\n    },\n    code,\n    evaluator,\n    evalConfig,\n  };\n}\n\nexport function getStack(entrypoint: ParentEntrypoint) {\n  if (!entrypoint) return [];\n\n  const stack = [entrypoint.name];\n\n  let { parents } = entrypoint;\n  while (parents.length) {\n    stack.push(parents[0].name);\n    parents = parents[0].parents;\n  }\n\n  return stack;\n}\n\nexport function mergeOnly(a: string[], b: string[]) {\n  const result = new Set(a);\n  b.forEach((item) => result.add(item));\n  return [...result].filter((i) => i).sort();\n}\n\nexport const isSuperSet = <T>(a: (T | '*')[], b: (T | '*')[]) => {\n  if (a.includes('*')) return true;\n  if (b.length === 0) return true;\n  const aSet = new Set(a);\n  return b.every((item) => aSet.has(item));\n};\n"],"mappings":"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"}