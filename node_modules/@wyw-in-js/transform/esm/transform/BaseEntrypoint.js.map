{"version":3,"file":"BaseEntrypoint.js","names":["getFileIdx","hasKey","obj","key","VALUES","Symbol","isProxy","createExports","log","exports","lazyFields","Set","Proxy","get","_target","value","Reflect","undefined","defaultValue","default","has","ownKeys","Object","keys","set","delete","defineProperty","descriptor","prev","v","add","getOwnPropertyDescriptor","enumerable","configurable","EXPORTS","entrypointSeqId","BaseEntrypoint","seqId","constructor","services","evaluatedOnly","generation","name","only","parents","idx","extend","ref","isExportsInherited","eventEmitter","entrypointEvent","class","filename","parentId","type","exportsProxy"],"sources":["../../src/transform/BaseEntrypoint.ts"],"sourcesContent":["/* eslint-disable no-param-reassign */\nimport type { Debugger } from '@wyw-in-js/shared';\n\nimport type { ParentEntrypoint } from '../types';\nimport { getFileIdx } from '../utils/getFileIdx';\n\nimport type { Services } from './types';\n\nconst hasKey = <TKey extends string | symbol>(\n  obj: unknown,\n  key: TKey\n): obj is Record<TKey, unknown> =>\n  (typeof obj === 'object' || typeof obj === 'function') &&\n  obj !== null &&\n  key in obj;\n\nconst VALUES = Symbol('values');\n\nconst isProxy = (\n  obj: unknown\n): obj is { [VALUES]: Record<string | symbol, unknown> } =>\n  typeof obj === 'object' && obj !== null && VALUES in obj;\n\nexport const createExports = (log: Debugger) => {\n  let exports: Record<string | symbol, unknown> = {};\n  const lazyFields = new Set<string | symbol>();\n\n  return new Proxy(exports, {\n    get: (_target, key) => {\n      if (key === VALUES) {\n        return exports;\n      }\n\n      let value: unknown;\n      if (key in exports) {\n        value = exports[key];\n      } else {\n        // Support Object.prototype methods on `exports`\n        // e.g `exports.hasOwnProperty`\n        value = Reflect.get(exports, key);\n      }\n\n      if (value === undefined && 'default' in exports) {\n        const defaultValue = exports.default;\n        if (hasKey(defaultValue, key)) {\n          log(\n            '⚠️  %s has been found in `default`. It indicates that ESM to CJS conversion went wrong.',\n            key\n          );\n          value = defaultValue[key];\n        }\n      }\n\n      if (value !== undefined && lazyFields.has(key)) {\n        value = (value as () => unknown)();\n      }\n\n      log('get %s: %o', key, value);\n      return value;\n    },\n    has: (_target, key) => {\n      if (key === VALUES) return true;\n      return key in exports;\n    },\n    ownKeys: () => {\n      return Object.keys(exports);\n    },\n    set: (_target, key, value) => {\n      if (key === VALUES) {\n        exports = value;\n        return true;\n      }\n\n      if (key !== '__esModule') {\n        log('set %s: %o', key, value);\n      }\n\n      if (value !== undefined) {\n        exports[key] = value;\n        lazyFields.delete(key);\n      }\n\n      return true;\n    },\n    defineProperty: (_target, key, descriptor) => {\n      const { value } = descriptor;\n      if (value !== undefined) {\n        if (key !== '__esModule') {\n          log('defineProperty %s with value %o', key, value);\n        }\n\n        exports[key] = value;\n        lazyFields.delete(key);\n\n        return true;\n      }\n\n      if ('get' in descriptor) {\n        if (lazyFields.has(key)) {\n          const prev = exports[key] as () => void;\n          exports[key] = () => {\n            const v = descriptor.get?.();\n            if (v !== undefined) {\n              return v;\n            }\n\n            return prev();\n          };\n        } else {\n          const prev = exports[key];\n          exports[key] = () => {\n            const v = descriptor.get?.();\n            if (v !== undefined) {\n              return v;\n            }\n\n            return prev;\n          };\n        }\n\n        lazyFields.add(key);\n        log('defineProperty %s with getter', key);\n      }\n\n      return true;\n    },\n    getOwnPropertyDescriptor: (_target, key) => {\n      if (key in exports)\n        return {\n          enumerable: true,\n          configurable: true,\n        };\n\n      return undefined;\n    },\n  });\n};\n\nconst EXPORTS = Symbol('exports');\n\nlet entrypointSeqId = 0;\n\nexport abstract class BaseEntrypoint {\n  public static createExports = createExports;\n\n  public readonly idx: string;\n\n  public readonly log: Debugger;\n\n  // eslint-disable-next-line no-plusplus\n  public readonly seqId = entrypointSeqId++;\n\n  readonly #exports: Record<string | symbol, unknown>;\n\n  protected constructor(\n    protected services: Services,\n    public readonly evaluatedOnly: string[],\n    exports: Record<string | symbol, unknown> | undefined,\n    public readonly generation: number,\n    public readonly name: string,\n    public readonly only: string[],\n    public readonly parents: ParentEntrypoint[]\n  ) {\n    this.idx = getFileIdx(name);\n    this.log =\n      parents[0]?.log.extend(this.ref, '->') ?? services.log.extend(this.ref);\n\n    let isExportsInherited = false;\n    if (exports) {\n      if (isProxy(exports)) {\n        this.#exports = exports;\n        isExportsInherited = true;\n      } else {\n        this.#exports = createExports(this.log);\n        this.#exports[EXPORTS] = exports;\n      }\n      this.exports = exports;\n    } else {\n      this.#exports = BaseEntrypoint.createExports(this.log);\n    }\n\n    services.eventEmitter.entrypointEvent(this.seqId, {\n      class: this.constructor.name,\n      evaluatedOnly: this.evaluatedOnly,\n      filename: name,\n      generation,\n      idx: this.idx,\n      isExportsInherited,\n      only,\n      parentId: parents[0]?.seqId ?? null,\n      type: 'created',\n    });\n  }\n\n  public get exports(): Record<string | symbol, unknown> {\n    if (EXPORTS in this.#exports) {\n      return this.#exports[EXPORTS] as Record<string | symbol, unknown>;\n    }\n\n    return this.#exports;\n  }\n\n  public set exports(value: unknown) {\n    if (isProxy(value)) {\n      this.#exports[VALUES] = value[VALUES];\n    } else {\n      this.#exports[EXPORTS] = value;\n    }\n  }\n\n  public get ref() {\n    return `${this.idx}#${this.generation}`;\n  }\n\n  protected get exportsProxy() {\n    return this.#exports;\n  }\n}\n"],"mappings":"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"}