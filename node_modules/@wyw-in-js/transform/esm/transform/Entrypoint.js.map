{"version":3,"file":"Entrypoint.js","names":["invariant","BaseEntrypoint","isSuperSet","mergeOnly","EvaluatedEntrypoint","AbortError","BaseAction","UnprocessedEntrypointError","EMPTY_FILE","hasLoop","name","parent","processed","includes","p","parents","found","Entrypoint","evaluated","onSupersedeHandlers","actionsCache","Map","hasWywMetadata","supersededWith","transformResultCode","constructor","services","initialCode","only","exports","evaluatedOnly","loadedAndParsed","resolveTasks","dependencies","generation","loadAndParseFn","log","code","undefined","cache","invalidateIfChanged","evaluator","originalCode","extend","ignored","transformedCode","createRoot","loadedCode","created","create","eventEmitter","perf","status","entrypoint","innerCreate","seqId","add","cached","get","changed","mergedOnly","filter","i","isLoop","map","push","supersede","newEntrypoint","addDependency","dependency","delete","source","set","addResolveTask","assertNotSuperseded","assertTransformed","createAction","actionType","data","abortSignal","has","aborted","newAction","entrypointEvent","type","actionIdx","idx","createChild","createEvaluated","exportsProxy","getDependency","getResolveTask","onSupersede","callback","index","indexOf","splice","setTransformResult","res","Boolean","metadata","isNull","newOnlyOrEntrypoint","with","forEach","handler"],"sources":["../../src/transform/Entrypoint.ts"],"sourcesContent":["import { invariant } from 'ts-invariant';\n\nimport type { ParentEntrypoint, ITransformFileResult } from '../types';\n\nimport { BaseEntrypoint } from './BaseEntrypoint';\nimport { isSuperSet, mergeOnly } from './Entrypoint.helpers';\nimport type {\n  IEntrypointCode,\n  IEntrypointDependency,\n  IIgnoredEntrypoint,\n} from './Entrypoint.types';\nimport { EvaluatedEntrypoint } from './EvaluatedEntrypoint';\nimport { AbortError } from './actions/AbortError';\nimport type { ActionByType } from './actions/BaseAction';\nimport { BaseAction } from './actions/BaseAction';\nimport { UnprocessedEntrypointError } from './actions/UnprocessedEntrypointError';\nimport type { Services, ActionTypes, ActionQueueItem } from './types';\n\nconst EMPTY_FILE = '=== empty file ===';\n\nfunction hasLoop(\n  name: string,\n  parent: ParentEntrypoint,\n  processed: string[] = []\n): boolean {\n  if (parent.name === name || processed.includes(parent.name)) {\n    return true;\n  }\n\n  for (const p of parent.parents) {\n    const found = hasLoop(name, p, [...processed, parent.name]);\n    if (found) {\n      return found;\n    }\n  }\n\n  return false;\n}\n\nexport class Entrypoint extends BaseEntrypoint {\n  public readonly evaluated = false;\n\n  public readonly loadedAndParsed: IEntrypointCode | IIgnoredEntrypoint;\n\n  protected onSupersedeHandlers: Array<(newEntrypoint: Entrypoint) => void> =\n    [];\n\n  private actionsCache: Map<\n    ActionTypes,\n    Map<unknown, BaseAction<ActionQueueItem>>\n  > = new Map();\n\n  #hasWywMetadata: boolean = false;\n\n  #supersededWith: Entrypoint | null = null;\n\n  #transformResultCode: string | null = null;\n\n  private constructor(\n    services: Services,\n    parents: ParentEntrypoint[],\n    public readonly initialCode: string | undefined,\n    name: string,\n    only: string[],\n    exports: Record<string | symbol, unknown> | undefined,\n    evaluatedOnly: string[],\n    loadedAndParsed?: IEntrypointCode | IIgnoredEntrypoint,\n    protected readonly resolveTasks = new Map<\n      string,\n      Promise<IEntrypointDependency>\n    >(),\n    protected readonly dependencies = new Map<string, IEntrypointDependency>(),\n    generation = 1\n  ) {\n    super(services, evaluatedOnly, exports, generation, name, only, parents);\n\n    this.loadedAndParsed =\n      loadedAndParsed ??\n      services.loadAndParseFn(\n        services,\n        name,\n        initialCode,\n        parents[0]?.log ?? services.log\n      );\n\n    if (this.loadedAndParsed.code !== undefined) {\n      services.cache.invalidateIfChanged(name, this.loadedAndParsed.code);\n    }\n\n    const code =\n      this.loadedAndParsed.evaluator === 'ignored'\n        ? '[IGNORED]'\n        : this.originalCode || EMPTY_FILE;\n\n    this.log.extend('source')('created %s (%o)\\n%s', name, only, code);\n  }\n\n  public get ignored() {\n    return this.loadedAndParsed.evaluator === 'ignored';\n  }\n\n  public get originalCode() {\n    return this.loadedAndParsed.code;\n  }\n\n  public get supersededWith(): Entrypoint | null {\n    return this.#supersededWith?.supersededWith ?? this.#supersededWith;\n  }\n\n  public get transformedCode(): string | null {\n    return (\n      this.#transformResultCode ?? this.supersededWith?.transformedCode ?? null\n    );\n  }\n\n  public static createRoot(\n    services: Services,\n    name: string,\n    only: string[],\n    loadedCode: string | undefined\n  ): Entrypoint {\n    const created = Entrypoint.create(services, null, name, only, loadedCode);\n    invariant(created !== 'loop', 'loop detected');\n\n    return created;\n  }\n\n  /**\n   * Creates an entrypoint for the specified file.\n   * If there is already an entrypoint for this file, there will be four possible outcomes:\n   * 1. If `loadedCode` is specified and is different from the one that was used to create the existing entrypoint,\n   *   the existing entrypoint will be superseded by a new one and all cached results for it will be invalidated.\n   *   It can happen if the file was changed and the watcher notified us about it, or we received a new version\n   *   of the file from a loader whereas the previous one was loaded from the filesystem.\n   *   The new entrypoint will be returned.\n   * 2. If `only` is subset of the existing entrypoint's `only`, the existing entrypoint will be returned.\n   * 3. If `only` is superset of the existing entrypoint's `only`, the existing entrypoint will be superseded and the new one will be returned.\n   * 4. If a loop is detected, 'ignored' will be returned, the existing entrypoint will be superseded or not depending on the `only` value.\n   */\n  protected static create(\n    services: Services,\n    parent: ParentEntrypoint | null,\n    name: string,\n    only: string[],\n    loadedCode: string | undefined\n  ): Entrypoint | 'loop' {\n    const { cache, eventEmitter } = services;\n    return eventEmitter.perf('createEntrypoint', () => {\n      const [status, entrypoint] = Entrypoint.innerCreate(\n        services,\n        parent\n          ? {\n              evaluated: parent.evaluated,\n              log: parent.log,\n              name: parent.name,\n              parents: parent.parents,\n              seqId: parent.seqId,\n            }\n          : null,\n        name,\n        only,\n        loadedCode\n      );\n\n      if (status !== 'cached') {\n        cache.add('entrypoints', name, entrypoint);\n      }\n\n      return status === 'loop' ? 'loop' : entrypoint;\n    });\n  }\n\n  private static innerCreate(\n    services: Services,\n    parent: ParentEntrypoint | null,\n    name: string,\n    only: string[],\n    loadedCode: string | undefined\n  ): ['loop' | 'created' | 'cached', Entrypoint] {\n    const { cache } = services;\n\n    const cached = cache.get('entrypoints', name);\n    const changed =\n      loadedCode !== undefined\n        ? cache.invalidateIfChanged(name, loadedCode)\n        : false;\n\n    if (!cached?.evaluated && cached?.ignored) {\n      return ['cached', cached];\n    }\n\n    const exports = cached?.exports;\n    const evaluatedOnly = cached?.evaluatedOnly ?? [];\n    const mergedOnly =\n      !changed && cached?.only\n        ? mergeOnly(cached.only, only).filter((i) => !evaluatedOnly.includes(i))\n        : only;\n\n    if (cached?.evaluated) {\n      cached.log('is already evaluated with', cached.evaluatedOnly);\n    }\n\n    if (!changed && cached && !cached.evaluated) {\n      const isLoop = parent && hasLoop(name, parent);\n      if (isLoop) {\n        parent.log('[createEntrypoint] %s is a loop', name);\n      }\n\n      if (parent && !cached.parents.map((p) => p.name).includes(parent.name)) {\n        cached.parents.push(parent);\n      }\n\n      if (isSuperSet(cached.only, mergedOnly)) {\n        cached.log('is cached', name);\n        return [isLoop ? 'loop' : 'cached', cached];\n      }\n\n      cached.log(\n        'is cached, but with different `only` %o (the cached one %o)',\n        only,\n        cached?.only\n      );\n\n      return [isLoop ? 'loop' : 'created', cached.supersede(mergedOnly)];\n    }\n\n    const newEntrypoint = new Entrypoint(\n      services,\n      parent ? [parent] : [],\n      loadedCode,\n      name,\n      mergedOnly,\n      exports,\n      evaluatedOnly,\n      undefined,\n      cached && 'resolveTasks' in cached ? cached.resolveTasks : undefined,\n      cached && 'dependencies' in cached ? cached.dependencies : undefined,\n      cached ? cached.generation + 1 : 1\n    );\n\n    if (cached && !cached.evaluated) {\n      cached.log('is cached, but with different code');\n      cached.supersede(newEntrypoint);\n    }\n\n    return ['created', newEntrypoint];\n  }\n\n  public addDependency(dependency: IEntrypointDependency): void {\n    this.resolveTasks.delete(dependency.source);\n    this.dependencies.set(dependency.source, dependency);\n  }\n\n  public addResolveTask(\n    name: string,\n    dependency: Promise<IEntrypointDependency>\n  ): void {\n    this.resolveTasks.set(name, dependency);\n  }\n\n  public assertNotSuperseded() {\n    if (this.supersededWith) {\n      this.log('superseded');\n      throw new AbortError('superseded');\n    }\n  }\n\n  public assertTransformed() {\n    if (this.transformedCode === null) {\n      this.log('not transformed');\n      throw new UnprocessedEntrypointError(this.supersededWith ?? this);\n    }\n  }\n\n  public createAction<\n    TType extends ActionTypes,\n    TAction extends ActionByType<TType>,\n  >(\n    actionType: TType,\n    data: TAction['data'],\n    abortSignal: AbortSignal | null = null\n  ): BaseAction<TAction> {\n    if (!this.actionsCache.has(actionType)) {\n      this.actionsCache.set(actionType, new Map());\n    }\n\n    const cache = this.actionsCache.get(actionType)!;\n    const cached = cache.get(data);\n    if (cached && !cached.abortSignal?.aborted) {\n      return cached as BaseAction<TAction>;\n    }\n\n    const newAction = new BaseAction<TAction>(\n      actionType as TAction['type'],\n      this.services,\n      this,\n      data,\n      abortSignal\n    );\n\n    cache.set(data, newAction);\n\n    this.services.eventEmitter.entrypointEvent(this.seqId, {\n      type: 'actionCreated',\n      actionType,\n      actionIdx: newAction.idx,\n    });\n\n    return newAction;\n  }\n\n  public createChild(\n    name: string,\n    only: string[],\n    loadedCode?: string\n  ): Entrypoint | 'loop' {\n    return Entrypoint.create(this.services, this, name, only, loadedCode);\n  }\n\n  public createEvaluated() {\n    const evaluatedOnly = mergeOnly(this.evaluatedOnly, this.only);\n    this.log('create EvaluatedEntrypoint for %o', evaluatedOnly);\n\n    return new EvaluatedEntrypoint(\n      this.services,\n      evaluatedOnly,\n      this.exportsProxy,\n      this.generation + 1,\n      this.name,\n      this.only,\n      this.parents\n    );\n  }\n\n  public getDependency(name: string): IEntrypointDependency | undefined {\n    return this.dependencies.get(name);\n  }\n\n  public getResolveTask(\n    name: string\n  ): Promise<IEntrypointDependency> | undefined {\n    return this.resolveTasks.get(name);\n  }\n\n  public hasWywMetadata() {\n    return this.#hasWywMetadata;\n  }\n\n  public onSupersede(callback: (newEntrypoint: Entrypoint) => void) {\n    if (this.#supersededWith) {\n      callback(this.#supersededWith);\n      return () => {};\n    }\n\n    this.onSupersedeHandlers.push(callback);\n\n    return () => {\n      const index = this.onSupersedeHandlers.indexOf(callback);\n      if (index >= 0) {\n        this.onSupersedeHandlers.splice(index, 1);\n      }\n    };\n  }\n\n  public setTransformResult(res: ITransformFileResult | null) {\n    this.#hasWywMetadata = Boolean(res?.metadata);\n    this.#transformResultCode = res?.code ?? null;\n\n    this.services.eventEmitter.entrypointEvent(this.seqId, {\n      isNull: res === null,\n      type: 'setTransformResult',\n    });\n  }\n\n  private supersede(newOnlyOrEntrypoint: string[] | Entrypoint): Entrypoint {\n    const newEntrypoint =\n      newOnlyOrEntrypoint instanceof Entrypoint\n        ? newOnlyOrEntrypoint\n        : new Entrypoint(\n            this.services,\n            this.parents,\n            this.initialCode,\n            this.name,\n            newOnlyOrEntrypoint,\n            this.exports,\n            this.evaluatedOnly,\n            this.loadedAndParsed,\n            this.resolveTasks,\n            this.dependencies,\n            this.generation + 1\n          );\n\n    this.services.eventEmitter.entrypointEvent(this.seqId, {\n      type: 'superseded',\n      with: newEntrypoint.seqId,\n    });\n    this.log(\n      'superseded by %s (%o -> %o)',\n      newEntrypoint.name,\n      this.only,\n      newEntrypoint.only\n    );\n    this.#supersededWith = newEntrypoint;\n    this.onSupersedeHandlers.forEach((handler) => handler(newEntrypoint));\n\n    return newEntrypoint;\n  }\n}\n"],"mappings":"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"}