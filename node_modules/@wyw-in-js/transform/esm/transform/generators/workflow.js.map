{"version":3,"file":"workflow.js","names":["isAborted","workflow","cache","options","services","entrypoint","ignored","code","loadedAndParsed","sourceMap","inputSourceMap","getNext","undefined","assertNotSuperseded","e","supersededWith","log","originalCode","hasWywMetadata","generation","delete","name","evalStageResult","valueCache","dependencies","collectStageResult","metadata","map","extractStageResult","processors","replacements"],"sources":["../../../src/transform/generators/workflow.ts"],"sourcesContent":["import { isAborted } from '../actions/AbortError';\nimport type { IWorkflowAction, SyncScenarioForAction } from '../types';\n\n/**\n * The entry point for file processing. Sequentially calls `processEntrypoint`,\n * `evalFile`, `collect`, and `extract`. Returns the result of transforming\n * the source code as well as all artifacts obtained from code execution.\n */\nexport function* workflow(\n  this: IWorkflowAction\n): SyncScenarioForAction<IWorkflowAction> {\n  const { cache, options } = this.services;\n  const { entrypoint } = this;\n\n  if (entrypoint.ignored) {\n    return {\n      code: entrypoint.loadedAndParsed.code ?? '',\n      sourceMap: options.inputSourceMap,\n    };\n  }\n\n  try {\n    yield* this.getNext('processEntrypoint', entrypoint, undefined, null);\n    entrypoint.assertNotSuperseded();\n  } catch (e) {\n    if (isAborted(e) && entrypoint.supersededWith) {\n      entrypoint.log('workflow aborted, schedule the next attempt');\n      return yield* this.getNext(\n        'workflow',\n        entrypoint.supersededWith,\n        undefined,\n        null\n      );\n    }\n\n    throw e;\n  }\n\n  const originalCode = entrypoint.loadedAndParsed.code ?? '';\n\n  // File is ignored or does not contain any tags. Return original code.\n  if (!entrypoint.hasWywMetadata()) {\n    if (entrypoint.generation === 1) {\n      // 1st generation here means that it's __wywPreval entrypoint\n      // without __wywPreval, so we don't need it cached\n      cache.delete('entrypoints', entrypoint.name);\n    }\n\n    return {\n      code: originalCode,\n      sourceMap: options.inputSourceMap,\n    };\n  }\n\n  // *** 2nd stage ***\n\n  const evalStageResult = yield* this.getNext(\n    'evalFile',\n    entrypoint,\n    undefined,\n    null\n  );\n\n  if (evalStageResult === null) {\n    return {\n      code: originalCode,\n      sourceMap: options.inputSourceMap,\n    };\n  }\n\n  const [valueCache, dependencies] = evalStageResult;\n\n  // *** 3rd stage ***\n\n  const collectStageResult = yield* this.getNext(\n    'collect',\n    entrypoint,\n    {\n      valueCache,\n    },\n    null\n  );\n\n  if (!collectStageResult.metadata) {\n    return {\n      code: collectStageResult.code!,\n      sourceMap: collectStageResult.map,\n    };\n  }\n\n  // *** 4th stage\n\n  const extractStageResult = yield* this.getNext(\n    'extract',\n    entrypoint,\n    {\n      processors: collectStageResult.metadata.processors,\n    },\n    null\n  );\n\n  return {\n    ...extractStageResult,\n    code: collectStageResult.code ?? '',\n    dependencies,\n    replacements: [\n      ...extractStageResult.replacements,\n      ...collectStageResult.metadata.replacements,\n    ],\n    sourceMap: collectStageResult.map,\n  };\n}\n"],"mappings":"AAAA,SAASA,SAAS,QAAQ,uBAAuB;AAGjD;AACA;AACA;AACA;AACA;AACA,OAAO,UAAUC,QAAQA,CAAA,EAEiB;EACxC,MAAM;IAAEC,KAAK;IAAEC;EAAQ,CAAC,GAAG,IAAI,CAACC,QAAQ;EACxC,MAAM;IAAEC;EAAW,CAAC,GAAG,IAAI;EAE3B,IAAIA,UAAU,CAACC,OAAO,EAAE;IACtB,OAAO;MACLC,IAAI,EAAEF,UAAU,CAACG,eAAe,CAACD,IAAI,IAAI,EAAE;MAC3CE,SAAS,EAAEN,OAAO,CAACO;IACrB,CAAC;EACH;EAEA,IAAI;IACF,OAAO,IAAI,CAACC,OAAO,CAAC,mBAAmB,EAAEN,UAAU,EAAEO,SAAS,EAAE,IAAI,CAAC;IACrEP,UAAU,CAACQ,mBAAmB,CAAC,CAAC;EAClC,CAAC,CAAC,OAAOC,CAAC,EAAE;IACV,IAAId,SAAS,CAACc,CAAC,CAAC,IAAIT,UAAU,CAACU,cAAc,EAAE;MAC7CV,UAAU,CAACW,GAAG,CAAC,6CAA6C,CAAC;MAC7D,OAAO,OAAO,IAAI,CAACL,OAAO,CACxB,UAAU,EACVN,UAAU,CAACU,cAAc,EACzBH,SAAS,EACT,IACF,CAAC;IACH;IAEA,MAAME,CAAC;EACT;EAEA,MAAMG,YAAY,GAAGZ,UAAU,CAACG,eAAe,CAACD,IAAI,IAAI,EAAE;;EAE1D;EACA,IAAI,CAACF,UAAU,CAACa,cAAc,CAAC,CAAC,EAAE;IAChC,IAAIb,UAAU,CAACc,UAAU,KAAK,CAAC,EAAE;MAC/B;MACA;MACAjB,KAAK,CAACkB,MAAM,CAAC,aAAa,EAAEf,UAAU,CAACgB,IAAI,CAAC;IAC9C;IAEA,OAAO;MACLd,IAAI,EAAEU,YAAY;MAClBR,SAAS,EAAEN,OAAO,CAACO;IACrB,CAAC;EACH;;EAEA;;EAEA,MAAMY,eAAe,GAAG,OAAO,IAAI,CAACX,OAAO,CACzC,UAAU,EACVN,UAAU,EACVO,SAAS,EACT,IACF,CAAC;EAED,IAAIU,eAAe,KAAK,IAAI,EAAE;IAC5B,OAAO;MACLf,IAAI,EAAEU,YAAY;MAClBR,SAAS,EAAEN,OAAO,CAACO;IACrB,CAAC;EACH;EAEA,MAAM,CAACa,UAAU,EAAEC,YAAY,CAAC,GAAGF,eAAe;;EAElD;;EAEA,MAAMG,kBAAkB,GAAG,OAAO,IAAI,CAACd,OAAO,CAC5C,SAAS,EACTN,UAAU,EACV;IACEkB;EACF,CAAC,EACD,IACF,CAAC;EAED,IAAI,CAACE,kBAAkB,CAACC,QAAQ,EAAE;IAChC,OAAO;MACLnB,IAAI,EAAEkB,kBAAkB,CAAClB,IAAK;MAC9BE,SAAS,EAAEgB,kBAAkB,CAACE;IAChC,CAAC;EACH;;EAEA;;EAEA,MAAMC,kBAAkB,GAAG,OAAO,IAAI,CAACjB,OAAO,CAC5C,SAAS,EACTN,UAAU,EACV;IACEwB,UAAU,EAAEJ,kBAAkB,CAACC,QAAQ,CAACG;EAC1C,CAAC,EACD,IACF,CAAC;EAED,OAAO;IACL,GAAGD,kBAAkB;IACrBrB,IAAI,EAAEkB,kBAAkB,CAAClB,IAAI,IAAI,EAAE;IACnCiB,YAAY;IACZM,YAAY,EAAE,CACZ,GAAGF,kBAAkB,CAACE,YAAY,EAClC,GAAGL,kBAAkB,CAACC,QAAQ,CAACI,YAAY,CAC5C;IACDrB,SAAS,EAAEgB,kBAAkB,CAACE;EAChC,CAAC;AACH"}