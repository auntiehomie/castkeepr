{"version":3,"file":"createStylisPreprocessor.js","names":["path","compile","middleware","prefixer","serialize","stringify","tokenize","RULESET","KEYFRAMES","DECLARATION","POSIX_SEP","posix","sep","transformUrl","url","outputFilename","sourceFilename","platformPath","relative","dirname","resolve","split","join","DEFINED_KEYFRAMES","Symbol","ORIGINAL_KEYFRAME_NAME","ORIGINAL_VALUE_KEY","IS_GLOBAL_KEYFRAMES","getOriginalElementValue","element","value","throwIfNotProd","key","type","process","env","NODE_ENV","Error","JSON","childrenIsString","children","propsAreStrings","props","Array","isArray","propsIsString","isDeclaration","isKeyframes","isRuleset","nonMediaParent","parent","stylisGlobalPlugin","getGlobalSelectorModifiers","el","parentValue","length","includes","match","baseSelector","spaceDelimiter","includeBaseSelector","includeSpaceDelimiter","Object","assign","map","cssSelector","tokens","selector","i","len","token","slice","createStylisUrlReplacePlugin","filename","return","replace","_match","p1","_p2","p3","p4","createKeyframeSuffixerPlugin","prefixes","getPrefixedProp","prop","prefix","buildPropsRegexp","isAtRule","at","colon","RegExp","animationNameRegexp","getReplacer","startsWith","searchValue","replacer","input","fullMatch","undefined","rest","elementToKeyframeSuffix","replaceAll","animationPropsSet","Set","getDefinedKeyframes","keyframes","sibling","siblings","add","name","suffix","replaceFn","globalMatch","scopedMatch","originalName","isGlobal","keys","has","scopedKeyframes","patch","fromEntries","result","globalName","substring","isMiddleware","obj","createStylisPreprocessor","options","stylisPreprocess","text","compiled","filter"],"sources":["../../../src/transform/generators/createStylisPreprocessor.ts"],"sourcesContent":["/* eslint-disable no-continue */\nimport * as path from 'path';\nimport {\n  compile,\n  middleware,\n  prefixer,\n  serialize,\n  stringify,\n  tokenize,\n  RULESET,\n  KEYFRAMES,\n  DECLARATION,\n} from 'stylis';\nimport type { Middleware, Element } from 'stylis';\n\nimport type { Options } from '../../types';\n\nconst POSIX_SEP = path.posix.sep;\n\nexport function transformUrl(\n  url: string,\n  outputFilename: string,\n  sourceFilename: string,\n  platformPath: typeof path = path\n) {\n  // Replace asset path with new path relative to the output CSS\n  const relative = platformPath.relative(\n    platformPath.dirname(outputFilename),\n    // Get the absolute path to the asset from the path relative to the JS file\n    platformPath.resolve(platformPath.dirname(sourceFilename), url)\n  );\n\n  if (platformPath.sep === POSIX_SEP) {\n    return relative;\n  }\n\n  return relative.split(platformPath.sep).join(POSIX_SEP);\n}\n\ninterface IGlobalSelectorModifiers {\n  includeBaseSelector: boolean;\n  includeSpaceDelimiter: boolean;\n}\n\nconst DEFINED_KEYFRAMES = Symbol('definedKeyframes');\nconst ORIGINAL_KEYFRAME_NAME = Symbol('originalKeyframeName');\nconst ORIGINAL_VALUE_KEY = Symbol('originalValue');\nconst IS_GLOBAL_KEYFRAMES = Symbol('isGlobalKeyframes');\n\nconst getOriginalElementValue = (\n  element: (Element & { [ORIGINAL_VALUE_KEY]?: string }) | null\n) => {\n  return element ? element[ORIGINAL_VALUE_KEY] ?? element.value : '';\n};\n\nfunction throwIfNotProd(key: string, value: unknown, type: string): false {\n  if (process.env.NODE_ENV !== 'production') {\n    throw new Error(\n      `\"element.${key}\" has type \"${type}\" (${JSON.stringify(\n        value,\n        null,\n        2\n      )}), it's not expected. Please report a bug if it happens.`\n    );\n  }\n\n  return false;\n}\n\ntype SpecificElement<TFields> = Omit<Element, keyof TFields> & TFields;\ntype Declaration = SpecificElement<{\n  children: string;\n  props: string;\n  type: typeof DECLARATION;\n}>;\ntype Keyframes = SpecificElement<{\n  [IS_GLOBAL_KEYFRAMES]?: boolean;\n  props: string[];\n  type: typeof KEYFRAMES;\n}>;\ntype Ruleset = SpecificElement<{\n  props: string[];\n  type: typeof RULESET;\n}>;\n\nfunction childrenIsString(children: string | Element[]): children is string {\n  return (\n    typeof children === 'string' ||\n    throwIfNotProd('children', children, 'Element[]')\n  );\n}\n\nfunction propsAreStrings(props: string | string[]): props is string[] {\n  return Array.isArray(props) || throwIfNotProd('props', props, 'string');\n}\n\nfunction propsIsString(props: string | string[]): props is string {\n  return (\n    typeof props === 'string' || throwIfNotProd('props', props, 'string[]')\n  );\n}\n\nconst isDeclaration = (element: Element): element is Declaration => {\n  return (\n    element.type === DECLARATION &&\n    propsIsString(element.props) &&\n    childrenIsString(element.children)\n  );\n};\n\nconst isKeyframes = (element: Element): element is Keyframes => {\n  return element.type === KEYFRAMES && propsAreStrings(element.props);\n};\n\nconst isRuleset = (element: Element): element is Ruleset => {\n  return element.type === RULESET && propsAreStrings(element.props);\n};\n\nfunction nonMediaParent(element: Element): Element | null {\n  let { parent } = element;\n\n  while (parent) {\n    if (parent.type !== '@media') {\n      return parent;\n    }\n\n    parent = parent.parent;\n  }\n\n  return null;\n}\n\n/**\n * Stylis plugin that mimics :global() selector behavior from Stylis v3.\n */\nexport const stylisGlobalPlugin: Middleware = (element) => {\n  function getGlobalSelectorModifiers(el: Element): IGlobalSelectorModifiers {\n    const parent = nonMediaParent(el);\n\n    const value = getOriginalElementValue(el);\n    const parentValue = getOriginalElementValue(parent);\n\n    if (\n      (parent?.children.length === 0 && parentValue.includes(':global(')) ||\n      (parent && !value.includes(':global('))\n    ) {\n      return getGlobalSelectorModifiers(parent);\n    }\n\n    const match = value.match(/(&\\f( )?)?:global\\(/);\n\n    if (match === null) {\n      throw new Error(\n        `Failed to match :global() selector in \"${value}\". Please report a bug if it happens.`\n      );\n    }\n\n    const [, baseSelector, spaceDelimiter] = match;\n\n    return {\n      includeBaseSelector: !!baseSelector,\n      includeSpaceDelimiter: !!spaceDelimiter,\n    };\n  }\n\n  if (!isRuleset(element)) {\n    return;\n  }\n\n  Object.assign(element, {\n    props: element.props.map((cssSelector) => {\n      // The value can be changed by other middlewares, but we need an original one with `&`\n      Object.assign(element, { [ORIGINAL_VALUE_KEY]: element.value });\n\n      // Avoids calling tokenize() on every string\n      if (!cssSelector.includes(':global(')) {\n        return cssSelector;\n      }\n\n      if (element.children.length === 0) {\n        return cssSelector;\n      }\n\n      const { includeBaseSelector, includeSpaceDelimiter } =\n        getGlobalSelectorModifiers(element);\n\n      const tokens = tokenize(cssSelector);\n      let selector = '';\n\n      for (let i = 0, len = tokens.length; i < len; i++) {\n        const token = tokens[i];\n\n        //\n        // Match for \":global(\"\n        if (token === ':' && tokens[i + 1] === 'global') {\n          //\n          // Match for \":global()\"\n          if (tokens[i + 2] === '()') {\n            selector = [\n              ...tokens.slice(i + 4),\n              includeSpaceDelimiter ? ' ' : '',\n              ...(includeBaseSelector ? tokens.slice(0, i - 1) : []),\n              includeSpaceDelimiter ? '' : ' ',\n            ].join('');\n\n            break;\n          }\n\n          //\n          // Match for \":global(selector)\"\n          selector = [\n            tokens[i + 2].slice(1, -1),\n            includeSpaceDelimiter ? ' ' : '',\n            ...(includeBaseSelector ? tokens.slice(0, i - 1) : []),\n            includeSpaceDelimiter ? '' : ' ',\n          ].join('');\n\n          break;\n        }\n      }\n\n      return selector;\n    }),\n  });\n};\n\nexport function createStylisUrlReplacePlugin(\n  filename: string,\n  outputFilename: string | undefined\n): Middleware {\n  return (element) => {\n    if (element.type === 'decl' && outputFilename) {\n      // When writing to a file, we need to adjust the relative paths inside url(..) expressions.\n      // It'll allow css-loader to resolve an imported asset properly.\n      // eslint-disable-next-line no-param-reassign\n      element.return = element.value.replace(\n        /\\b(url\\(([\"']?))(\\.[^)]+?)(\\2\\))/g,\n        (_match, p1, _p2, p3, p4) =>\n          p1 + transformUrl(p3, outputFilename, filename) + p4\n      );\n    }\n  };\n}\n\nexport function createKeyframeSuffixerPlugin(): Middleware {\n  const prefixes = ['webkit', 'moz', 'ms', 'o', ''].map((i) =>\n    i ? `-${i}-` : ''\n  );\n\n  const getPrefixedProp = (prop: string): string[] =>\n    prefixes.map((prefix) => `${prefix}${prop}`);\n\n  const buildPropsRegexp = (prop: string, isAtRule: boolean) => {\n    const [at, colon] = isAtRule ? ['@', ''] : ['', ':'];\n    return new RegExp(\n      `^(${at}(?:${getPrefixedProp(prop).join('|')})${colon})\\\\s*`\n    );\n  };\n\n  const animationNameRegexp = /:global\\(([\\w_-]+)\\)|([\\w_-]+)/;\n\n  const getReplacer = (\n    startsWith: RegExp,\n    searchValue: RegExp,\n    replacer: (substring: string, ...matches: string[]) => string\n  ): ((input: string) => string) => {\n    return (input) => {\n      const [fullMatch] = input.match(startsWith) ?? [];\n      if (fullMatch === undefined) {\n        return input;\n      }\n\n      const rest = input.slice(fullMatch.length);\n      return fullMatch + rest.replace(searchValue, replacer);\n    };\n  };\n\n  const elementToKeyframeSuffix = (el: Element): string => {\n    if (el.parent) {\n      return elementToKeyframeSuffix(el.parent);\n    }\n\n    return el.value.replaceAll(/[^a-zA-Z0-9_-]/g, '');\n  };\n\n  const animationPropsSet = new Set([\n    ...getPrefixedProp('animation'),\n    ...getPrefixedProp('animation-name'),\n  ]);\n\n  const getDefinedKeyframes = (\n    element: Element & {\n      [DEFINED_KEYFRAMES]?: Set<string>;\n      siblings?: (Element & {\n        [IS_GLOBAL_KEYFRAMES]?: boolean;\n        [ORIGINAL_KEYFRAME_NAME]?: string;\n      })[];\n    }\n  ): Set<string> => {\n    if (element[DEFINED_KEYFRAMES]) {\n      return element[DEFINED_KEYFRAMES];\n    }\n\n    if (element.parent) {\n      return getDefinedKeyframes(element.parent);\n    }\n\n    const keyframes = new Set<string>();\n    for (const sibling of element.siblings ?? []) {\n      if (sibling[ORIGINAL_KEYFRAME_NAME]) {\n        keyframes.add(sibling[ORIGINAL_KEYFRAME_NAME]);\n        continue;\n      }\n\n      const name = sibling.props[0];\n      if (\n        !isKeyframes(sibling) ||\n        sibling[IS_GLOBAL_KEYFRAMES] === true ||\n        name?.startsWith(':global(')\n      ) {\n        continue;\n      }\n\n      keyframes.add(sibling.props[0]);\n    }\n\n    Object.assign(element, { [DEFINED_KEYFRAMES]: keyframes });\n\n    return keyframes;\n  };\n\n  return (element) => {\n    if (isKeyframes(element) && element.parent) {\n      const suffix = elementToKeyframeSuffix(element);\n\n      const replaceFn = (\n        _match: string,\n        globalMatch: string,\n        scopedMatch: string\n      ): string => globalMatch || `${scopedMatch}-${suffix}`;\n\n      const originalName = element.props[0];\n      const isGlobal = originalName?.startsWith(':global(') ?? false;\n\n      Object.assign(element, {\n        [ORIGINAL_KEYFRAME_NAME]: isGlobal ? undefined : originalName,\n        [IS_GLOBAL_KEYFRAMES]: isGlobal,\n        props: element.props.map(\n          getReplacer(/^\\s*/, animationNameRegexp, replaceFn)\n        ),\n        value: getReplacer(\n          buildPropsRegexp('keyframes', true),\n          animationNameRegexp,\n          replaceFn\n        )(element.value),\n      });\n\n      return;\n    }\n\n    if (isDeclaration(element)) {\n      const suffix = elementToKeyframeSuffix(element);\n      const keys = [\n        'children',\n        'return',\n        'value',\n      ] satisfies (keyof Declaration)[];\n\n      if (animationPropsSet.has(element.props)) {\n        const scopedKeyframes = getDefinedKeyframes(element);\n        const patch = Object.fromEntries(\n          keys.map((key) => {\n            const tokens = tokenize(element[key]);\n            let result = '';\n            for (let i = 0; i < tokens.length; i += 1) {\n              if (\n                tokens[i] === ':' &&\n                tokens[i + 1] === 'global' &&\n                tokens[i + 2].startsWith('(')\n              ) {\n                const globalName = tokens[i + 2].substring(\n                  1,\n                  tokens[i + 2].length - 1\n                );\n                i += 2;\n\n                result += globalName;\n                if (tokens[i + 1] !== ';') {\n                  result += ' ';\n                }\n                continue;\n              }\n\n              if (scopedKeyframes.has(tokens[i])) {\n                result += `${tokens[i]}-${suffix}`;\n                continue;\n              }\n\n              result += tokens[i];\n            }\n\n            return [key, result];\n          })\n        );\n\n        Object.assign(element, patch);\n      }\n    }\n  };\n}\n\nconst isMiddleware = (obj: Middleware | null): obj is Middleware =>\n  obj !== null;\n\nexport function createStylisPreprocessor(\n  options: Options & { prefixer?: boolean }\n) {\n  function stylisPreprocess(selector: string, text: string): string {\n    const compiled = compile(`${selector} {${text}}\\n`);\n\n    return serialize(\n      compiled,\n      middleware(\n        [\n          createStylisUrlReplacePlugin(\n            options.filename,\n            options.outputFilename\n          ),\n          stylisGlobalPlugin,\n          options.prefixer === false ? null : prefixer,\n          createKeyframeSuffixerPlugin(),\n          stringify,\n        ].filter(isMiddleware)\n      )\n    );\n  }\n\n  return stylisPreprocess;\n}\n"],"mappings":"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"}