{"version":3,"file":"Entrypoint.helpers.js","names":["_fs","require","_path","_shared","_buildOptions","_loadBabelOptions","_getFileIdx","_getPluginKey","getMatchedRule","rules","filename","code","i","length","rule","test","RegExp","action","parseFile","babel","originalCode","parseConfig","log","logger","extend","getFileIdx","parseResult","parseSync","Error","isModuleResolver","plugin","key","getPluginKey","includes","moduleResolverWarned","buildConfigs","services","name","pluginOptions","babelOptions","_parseConfig$plugins","_rawConfig$plugins","options","commonOptions","ast","inputSourceMap","root","sourceFileName","sourceMaps","rawConfig","buildOptions","useBabelConfigs","isFeatureEnabled","features","configFile","loadBabelOptions","babelrc","parseHasModuleResolver","plugins","some","rawHasModuleResolver","_parseConfig$plugins$","_parseConfig$plugins2","_rawConfig$plugins2","console","warn","filter","evalConfig","loadAndParse","loadedCode","eventEmitter","extension","extname","extensions","isAbsolute","readFileSync","evaluator","reason","getOrParse","perf","resolve","paths","dirname","default","getStack","entrypoint","stack","parents","push","mergeOnly","a","b","result","Set","forEach","item","add","sort","isSuperSet","aSet","every","has","exports"],"sources":["../../src/transform/Entrypoint.helpers.ts"],"sourcesContent":["import { readFileSync } from 'fs';\nimport { dirname, extname, isAbsolute } from 'path';\n\nimport type { TransformOptions, PluginItem } from '@babel/core';\nimport type { File } from '@babel/types';\n\nimport type {\n  Debugger,\n  EvalRule,\n  Evaluator,\n  StrictOptions,\n} from '@wyw-in-js/shared';\nimport { logger, isFeatureEnabled } from '@wyw-in-js/shared';\n\nimport type { Core } from '../babel';\nimport { buildOptions } from '../options/buildOptions';\nimport { loadBabelOptions } from '../options/loadBabelOptions';\nimport type { ParentEntrypoint } from '../types';\nimport { getFileIdx } from '../utils/getFileIdx';\nimport { getPluginKey } from '../utils/getPluginKey';\n\nimport type { IEntrypointCode, IIgnoredEntrypoint } from './Entrypoint.types';\nimport type { Services } from './types';\n\nexport function getMatchedRule(\n  rules: EvalRule[],\n  filename: string,\n  code: string\n): EvalRule {\n  for (let i = rules.length - 1; i >= 0; i--) {\n    const rule = rules[i];\n    if (!rule.test) {\n      return rule;\n    }\n\n    if (typeof rule.test === 'function' && rule.test(filename, code)) {\n      return rule;\n    }\n\n    if (rule.test instanceof RegExp && rule.test.test(filename)) {\n      return rule;\n    }\n  }\n\n  return { action: 'ignore' };\n}\n\nexport function parseFile(\n  babel: Core,\n  filename: string,\n  originalCode: string,\n  parseConfig: TransformOptions\n): File {\n  const log = logger.extend('transform:parse').extend(getFileIdx(filename));\n\n  const parseResult = babel.parseSync(originalCode, parseConfig);\n  if (!parseResult) {\n    throw new Error(`Failed to parse ${filename}`);\n  }\n\n  log('stage-1', `${filename} has been parsed`);\n\n  return parseResult;\n}\n\nconst isModuleResolver = (plugin: PluginItem) => {\n  const key = getPluginKey(plugin);\n  if (!key) return false;\n\n  if (['module-resolver', 'babel-plugin-module-resolver'].includes(key)) {\n    return true;\n  }\n\n  return /([\\\\/])babel-plugin-module-resolver\\1/.test(key);\n};\n\nlet moduleResolverWarned = false;\n\nfunction buildConfigs(\n  services: Services,\n  name: string,\n  pluginOptions: StrictOptions,\n  babelOptions: TransformOptions | undefined\n): {\n  evalConfig: TransformOptions;\n  parseConfig: TransformOptions;\n} {\n  const { babel, options } = services;\n\n  const commonOptions = {\n    ast: true,\n    filename: name,\n    inputSourceMap: options.inputSourceMap,\n    root: options.root,\n    sourceFileName: name,\n    sourceMaps: true,\n  };\n\n  const rawConfig = buildOptions(\n    pluginOptions?.babelOptions,\n    babelOptions,\n    commonOptions\n  );\n\n  const useBabelConfigs = isFeatureEnabled(\n    pluginOptions.features,\n    'useBabelConfigs',\n    name\n  );\n\n  if (!useBabelConfigs) {\n    rawConfig.configFile = false;\n  }\n\n  const parseConfig = loadBabelOptions(babel, name, {\n    babelrc: useBabelConfigs,\n    ...rawConfig,\n  });\n\n  const parseHasModuleResolver = parseConfig.plugins?.some(isModuleResolver);\n  const rawHasModuleResolver = rawConfig.plugins?.some(isModuleResolver);\n\n  if (parseHasModuleResolver && !rawHasModuleResolver) {\n    if (!moduleResolverWarned) {\n      // eslint-disable-next-line no-console\n      console.warn(\n        `[wyw-in-js] ${name} has a module-resolver plugin in its babelrc, but it is not present ` +\n          `in the babelOptions for the wyw-in-js plugin. This works for now but will be an error in the future. ` +\n          `Please add the module-resolver plugin to the babelOptions for the wyw-in-js plugin.`\n      );\n\n      moduleResolverWarned = true;\n    }\n\n    rawConfig.plugins = [\n      ...(parseConfig.plugins?.filter((plugin) => isModuleResolver(plugin)) ??\n        []),\n      ...(rawConfig.plugins ?? []),\n    ];\n  }\n\n  const evalConfig = loadBabelOptions(babel, name, {\n    babelrc: false,\n    ...rawConfig,\n  });\n\n  return {\n    evalConfig,\n    parseConfig,\n  };\n}\n\nexport function loadAndParse(\n  services: Services,\n  name: string,\n  loadedCode: string | undefined,\n  log: Debugger\n): IEntrypointCode | IIgnoredEntrypoint {\n  const {\n    babel,\n    eventEmitter,\n    options: { pluginOptions },\n  } = services;\n\n  const extension = extname(name);\n\n  if (!pluginOptions.extensions.includes(extension)) {\n    log(\n      '[createEntrypoint] %s is ignored. If you want it to be processed, you should add \\'%s\\' to the \"extensions\" option.',\n      name,\n      extension\n    );\n\n    return {\n      get code() {\n        if (isAbsolute(name)) {\n          return loadedCode ?? readFileSync(name, 'utf-8');\n        }\n\n        return ''; // it is a built-in module\n      },\n      evaluator: 'ignored',\n      reason: 'extension',\n    };\n  }\n\n  const code = loadedCode ?? readFileSync(name, 'utf-8');\n\n  const { action, babelOptions } = getMatchedRule(\n    pluginOptions.rules,\n    name,\n    code\n  );\n\n  let ast: File | undefined;\n\n  const { evalConfig, parseConfig } = buildConfigs(\n    services,\n    name,\n    pluginOptions,\n    babelOptions\n  );\n\n  const getOrParse = () => {\n    if (ast) return ast;\n    ast = eventEmitter.perf('parseFile', () =>\n      parseFile(babel, name, code, parseConfig)\n    );\n\n    return ast;\n  };\n\n  if (action === 'ignore') {\n    log('[createEntrypoint] %s is ignored by rule', name);\n    return {\n      get ast() {\n        return getOrParse();\n      },\n      code,\n      evaluator: 'ignored',\n      reason: 'rule',\n    };\n  }\n\n  const evaluator: Evaluator =\n    typeof action === 'function'\n      ? action\n      : require(\n          require.resolve(action, {\n            paths: [dirname(name)],\n          })\n        ).default;\n\n  return {\n    get ast() {\n      return getOrParse();\n    },\n    code,\n    evaluator,\n    evalConfig,\n  };\n}\n\nexport function getStack(entrypoint: ParentEntrypoint) {\n  if (!entrypoint) return [];\n\n  const stack = [entrypoint.name];\n\n  let { parents } = entrypoint;\n  while (parents.length) {\n    stack.push(parents[0].name);\n    parents = parents[0].parents;\n  }\n\n  return stack;\n}\n\nexport function mergeOnly(a: string[], b: string[]) {\n  const result = new Set(a);\n  b.forEach((item) => result.add(item));\n  return [...result].filter((i) => i).sort();\n}\n\nexport const isSuperSet = <T>(a: (T | '*')[], b: (T | '*')[]) => {\n  if (a.includes('*')) return true;\n  if (b.length === 0) return true;\n  const aSet = new Set(a);\n  return b.every((item) => aSet.has(item));\n};\n"],"mappings":"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"}