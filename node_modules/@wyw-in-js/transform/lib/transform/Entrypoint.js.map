{"version":3,"file":"Entrypoint.js","names":["_tsInvariant","require","_BaseEntrypoint","_Entrypoint","_EvaluatedEntrypoint","_AbortError","_BaseAction","_UnprocessedEntrypointError","EMPTY_FILE","hasLoop","name","parent","processed","includes","p","parents","found","Entrypoint","BaseEntrypoint","evaluated","onSupersedeHandlers","actionsCache","Map","hasWywMetadata","supersededWith","transformResultCode","constructor","services","initialCode","only","exports","evaluatedOnly","loadedAndParsed","resolveTasks","dependencies","generation","_parents$0$log","_parents$","loadAndParseFn","log","code","undefined","cache","invalidateIfChanged","evaluator","originalCode","extend","ignored","_this$supersededWith$","_this$supersededWith","transformedCode","_ref","_this$transformResult","_this$supersededWith2","createRoot","loadedCode","created","create","invariant","eventEmitter","perf","status","entrypoint","innerCreate","seqId","add","_cached$evaluatedOnly","cached","get","changed","mergedOnly","mergeOnly","filter","i","isLoop","map","push","isSuperSet","supersede","newEntrypoint","addDependency","dependency","delete","source","set","addResolveTask","assertNotSuperseded","AbortError","assertTransformed","_this$supersededWith3","UnprocessedEntrypointError","createAction","actionType","data","abortSignal","_cached$abortSignal","has","aborted","newAction","BaseAction","entrypointEvent","type","actionIdx","idx","createChild","createEvaluated","EvaluatedEntrypoint","exportsProxy","getDependency","getResolveTask","onSupersede","callback","index","indexOf","splice","setTransformResult","res","_res$code","Boolean","metadata","isNull","newOnlyOrEntrypoint","with","forEach","handler"],"sources":["../../src/transform/Entrypoint.ts"],"sourcesContent":["import { invariant } from 'ts-invariant';\n\nimport type { ParentEntrypoint, ITransformFileResult } from '../types';\n\nimport { BaseEntrypoint } from './BaseEntrypoint';\nimport { isSuperSet, mergeOnly } from './Entrypoint.helpers';\nimport type {\n  IEntrypointCode,\n  IEntrypointDependency,\n  IIgnoredEntrypoint,\n} from './Entrypoint.types';\nimport { EvaluatedEntrypoint } from './EvaluatedEntrypoint';\nimport { AbortError } from './actions/AbortError';\nimport type { ActionByType } from './actions/BaseAction';\nimport { BaseAction } from './actions/BaseAction';\nimport { UnprocessedEntrypointError } from './actions/UnprocessedEntrypointError';\nimport type { Services, ActionTypes, ActionQueueItem } from './types';\n\nconst EMPTY_FILE = '=== empty file ===';\n\nfunction hasLoop(\n  name: string,\n  parent: ParentEntrypoint,\n  processed: string[] = []\n): boolean {\n  if (parent.name === name || processed.includes(parent.name)) {\n    return true;\n  }\n\n  for (const p of parent.parents) {\n    const found = hasLoop(name, p, [...processed, parent.name]);\n    if (found) {\n      return found;\n    }\n  }\n\n  return false;\n}\n\nexport class Entrypoint extends BaseEntrypoint {\n  public readonly evaluated = false;\n\n  public readonly loadedAndParsed: IEntrypointCode | IIgnoredEntrypoint;\n\n  protected onSupersedeHandlers: Array<(newEntrypoint: Entrypoint) => void> =\n    [];\n\n  private actionsCache: Map<\n    ActionTypes,\n    Map<unknown, BaseAction<ActionQueueItem>>\n  > = new Map();\n\n  #hasWywMetadata: boolean = false;\n\n  #supersededWith: Entrypoint | null = null;\n\n  #transformResultCode: string | null = null;\n\n  private constructor(\n    services: Services,\n    parents: ParentEntrypoint[],\n    public readonly initialCode: string | undefined,\n    name: string,\n    only: string[],\n    exports: Record<string | symbol, unknown> | undefined,\n    evaluatedOnly: string[],\n    loadedAndParsed?: IEntrypointCode | IIgnoredEntrypoint,\n    protected readonly resolveTasks = new Map<\n      string,\n      Promise<IEntrypointDependency>\n    >(),\n    protected readonly dependencies = new Map<string, IEntrypointDependency>(),\n    generation = 1\n  ) {\n    super(services, evaluatedOnly, exports, generation, name, only, parents);\n\n    this.loadedAndParsed =\n      loadedAndParsed ??\n      services.loadAndParseFn(\n        services,\n        name,\n        initialCode,\n        parents[0]?.log ?? services.log\n      );\n\n    if (this.loadedAndParsed.code !== undefined) {\n      services.cache.invalidateIfChanged(name, this.loadedAndParsed.code);\n    }\n\n    const code =\n      this.loadedAndParsed.evaluator === 'ignored'\n        ? '[IGNORED]'\n        : this.originalCode || EMPTY_FILE;\n\n    this.log.extend('source')('created %s (%o)\\n%s', name, only, code);\n  }\n\n  public get ignored() {\n    return this.loadedAndParsed.evaluator === 'ignored';\n  }\n\n  public get originalCode() {\n    return this.loadedAndParsed.code;\n  }\n\n  public get supersededWith(): Entrypoint | null {\n    return this.#supersededWith?.supersededWith ?? this.#supersededWith;\n  }\n\n  public get transformedCode(): string | null {\n    return (\n      this.#transformResultCode ?? this.supersededWith?.transformedCode ?? null\n    );\n  }\n\n  public static createRoot(\n    services: Services,\n    name: string,\n    only: string[],\n    loadedCode: string | undefined\n  ): Entrypoint {\n    const created = Entrypoint.create(services, null, name, only, loadedCode);\n    invariant(created !== 'loop', 'loop detected');\n\n    return created;\n  }\n\n  /**\n   * Creates an entrypoint for the specified file.\n   * If there is already an entrypoint for this file, there will be four possible outcomes:\n   * 1. If `loadedCode` is specified and is different from the one that was used to create the existing entrypoint,\n   *   the existing entrypoint will be superseded by a new one and all cached results for it will be invalidated.\n   *   It can happen if the file was changed and the watcher notified us about it, or we received a new version\n   *   of the file from a loader whereas the previous one was loaded from the filesystem.\n   *   The new entrypoint will be returned.\n   * 2. If `only` is subset of the existing entrypoint's `only`, the existing entrypoint will be returned.\n   * 3. If `only` is superset of the existing entrypoint's `only`, the existing entrypoint will be superseded and the new one will be returned.\n   * 4. If a loop is detected, 'ignored' will be returned, the existing entrypoint will be superseded or not depending on the `only` value.\n   */\n  protected static create(\n    services: Services,\n    parent: ParentEntrypoint | null,\n    name: string,\n    only: string[],\n    loadedCode: string | undefined\n  ): Entrypoint | 'loop' {\n    const { cache, eventEmitter } = services;\n    return eventEmitter.perf('createEntrypoint', () => {\n      const [status, entrypoint] = Entrypoint.innerCreate(\n        services,\n        parent\n          ? {\n              evaluated: parent.evaluated,\n              log: parent.log,\n              name: parent.name,\n              parents: parent.parents,\n              seqId: parent.seqId,\n            }\n          : null,\n        name,\n        only,\n        loadedCode\n      );\n\n      if (status !== 'cached') {\n        cache.add('entrypoints', name, entrypoint);\n      }\n\n      return status === 'loop' ? 'loop' : entrypoint;\n    });\n  }\n\n  private static innerCreate(\n    services: Services,\n    parent: ParentEntrypoint | null,\n    name: string,\n    only: string[],\n    loadedCode: string | undefined\n  ): ['loop' | 'created' | 'cached', Entrypoint] {\n    const { cache } = services;\n\n    const cached = cache.get('entrypoints', name);\n    const changed =\n      loadedCode !== undefined\n        ? cache.invalidateIfChanged(name, loadedCode)\n        : false;\n\n    if (!cached?.evaluated && cached?.ignored) {\n      return ['cached', cached];\n    }\n\n    const exports = cached?.exports;\n    const evaluatedOnly = cached?.evaluatedOnly ?? [];\n    const mergedOnly =\n      !changed && cached?.only\n        ? mergeOnly(cached.only, only).filter((i) => !evaluatedOnly.includes(i))\n        : only;\n\n    if (cached?.evaluated) {\n      cached.log('is already evaluated with', cached.evaluatedOnly);\n    }\n\n    if (!changed && cached && !cached.evaluated) {\n      const isLoop = parent && hasLoop(name, parent);\n      if (isLoop) {\n        parent.log('[createEntrypoint] %s is a loop', name);\n      }\n\n      if (parent && !cached.parents.map((p) => p.name).includes(parent.name)) {\n        cached.parents.push(parent);\n      }\n\n      if (isSuperSet(cached.only, mergedOnly)) {\n        cached.log('is cached', name);\n        return [isLoop ? 'loop' : 'cached', cached];\n      }\n\n      cached.log(\n        'is cached, but with different `only` %o (the cached one %o)',\n        only,\n        cached?.only\n      );\n\n      return [isLoop ? 'loop' : 'created', cached.supersede(mergedOnly)];\n    }\n\n    const newEntrypoint = new Entrypoint(\n      services,\n      parent ? [parent] : [],\n      loadedCode,\n      name,\n      mergedOnly,\n      exports,\n      evaluatedOnly,\n      undefined,\n      cached && 'resolveTasks' in cached ? cached.resolveTasks : undefined,\n      cached && 'dependencies' in cached ? cached.dependencies : undefined,\n      cached ? cached.generation + 1 : 1\n    );\n\n    if (cached && !cached.evaluated) {\n      cached.log('is cached, but with different code');\n      cached.supersede(newEntrypoint);\n    }\n\n    return ['created', newEntrypoint];\n  }\n\n  public addDependency(dependency: IEntrypointDependency): void {\n    this.resolveTasks.delete(dependency.source);\n    this.dependencies.set(dependency.source, dependency);\n  }\n\n  public addResolveTask(\n    name: string,\n    dependency: Promise<IEntrypointDependency>\n  ): void {\n    this.resolveTasks.set(name, dependency);\n  }\n\n  public assertNotSuperseded() {\n    if (this.supersededWith) {\n      this.log('superseded');\n      throw new AbortError('superseded');\n    }\n  }\n\n  public assertTransformed() {\n    if (this.transformedCode === null) {\n      this.log('not transformed');\n      throw new UnprocessedEntrypointError(this.supersededWith ?? this);\n    }\n  }\n\n  public createAction<\n    TType extends ActionTypes,\n    TAction extends ActionByType<TType>,\n  >(\n    actionType: TType,\n    data: TAction['data'],\n    abortSignal: AbortSignal | null = null\n  ): BaseAction<TAction> {\n    if (!this.actionsCache.has(actionType)) {\n      this.actionsCache.set(actionType, new Map());\n    }\n\n    const cache = this.actionsCache.get(actionType)!;\n    const cached = cache.get(data);\n    if (cached && !cached.abortSignal?.aborted) {\n      return cached as BaseAction<TAction>;\n    }\n\n    const newAction = new BaseAction<TAction>(\n      actionType as TAction['type'],\n      this.services,\n      this,\n      data,\n      abortSignal\n    );\n\n    cache.set(data, newAction);\n\n    this.services.eventEmitter.entrypointEvent(this.seqId, {\n      type: 'actionCreated',\n      actionType,\n      actionIdx: newAction.idx,\n    });\n\n    return newAction;\n  }\n\n  public createChild(\n    name: string,\n    only: string[],\n    loadedCode?: string\n  ): Entrypoint | 'loop' {\n    return Entrypoint.create(this.services, this, name, only, loadedCode);\n  }\n\n  public createEvaluated() {\n    const evaluatedOnly = mergeOnly(this.evaluatedOnly, this.only);\n    this.log('create EvaluatedEntrypoint for %o', evaluatedOnly);\n\n    return new EvaluatedEntrypoint(\n      this.services,\n      evaluatedOnly,\n      this.exportsProxy,\n      this.generation + 1,\n      this.name,\n      this.only,\n      this.parents\n    );\n  }\n\n  public getDependency(name: string): IEntrypointDependency | undefined {\n    return this.dependencies.get(name);\n  }\n\n  public getResolveTask(\n    name: string\n  ): Promise<IEntrypointDependency> | undefined {\n    return this.resolveTasks.get(name);\n  }\n\n  public hasWywMetadata() {\n    return this.#hasWywMetadata;\n  }\n\n  public onSupersede(callback: (newEntrypoint: Entrypoint) => void) {\n    if (this.#supersededWith) {\n      callback(this.#supersededWith);\n      return () => {};\n    }\n\n    this.onSupersedeHandlers.push(callback);\n\n    return () => {\n      const index = this.onSupersedeHandlers.indexOf(callback);\n      if (index >= 0) {\n        this.onSupersedeHandlers.splice(index, 1);\n      }\n    };\n  }\n\n  public setTransformResult(res: ITransformFileResult | null) {\n    this.#hasWywMetadata = Boolean(res?.metadata);\n    this.#transformResultCode = res?.code ?? null;\n\n    this.services.eventEmitter.entrypointEvent(this.seqId, {\n      isNull: res === null,\n      type: 'setTransformResult',\n    });\n  }\n\n  private supersede(newOnlyOrEntrypoint: string[] | Entrypoint): Entrypoint {\n    const newEntrypoint =\n      newOnlyOrEntrypoint instanceof Entrypoint\n        ? newOnlyOrEntrypoint\n        : new Entrypoint(\n            this.services,\n            this.parents,\n            this.initialCode,\n            this.name,\n            newOnlyOrEntrypoint,\n            this.exports,\n            this.evaluatedOnly,\n            this.loadedAndParsed,\n            this.resolveTasks,\n            this.dependencies,\n            this.generation + 1\n          );\n\n    this.services.eventEmitter.entrypointEvent(this.seqId, {\n      type: 'superseded',\n      with: newEntrypoint.seqId,\n    });\n    this.log(\n      'superseded by %s (%o -> %o)',\n      newEntrypoint.name,\n      this.only,\n      newEntrypoint.only\n    );\n    this.#supersededWith = newEntrypoint;\n    this.onSupersedeHandlers.forEach((handler) => handler(newEntrypoint));\n\n    return newEntrypoint;\n  }\n}\n"],"mappings":"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"}