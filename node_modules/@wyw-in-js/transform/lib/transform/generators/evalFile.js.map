{"version":3,"file":"evalFile.js","names":["_evaluators","_interopRequireDefault","require","_hasWywPreval","_UnprocessedEntrypointError","obj","__esModule","default","wrap","fn","e","evalFile","entrypoint","log","evaluated","undefined","evaluate","services","isUnprocessedEntrypointError","wywPreval","hasWywPreval","value","__wywPreval","valueCache","Map","Object","entries","forEach","key","lazyValue","set","dependencies"],"sources":["../../../src/transform/generators/evalFile.ts"],"sourcesContent":["import type { ValueCache } from '@wyw-in-js/processor-utils';\n\nimport type { IEvaluateResult } from '../../evaluators';\nimport evaluate from '../../evaluators';\nimport hasWywPreval from '../../utils/hasWywPreval';\nimport { isUnprocessedEntrypointError } from '../actions/UnprocessedEntrypointError';\nimport type { IEvalAction, SyncScenarioForAction } from '../types';\n\nconst wrap = <T>(fn: () => T): T | Error => {\n  try {\n    return fn();\n  } catch (e) {\n    return e as Error;\n  }\n};\n\n/**\n * Executes the code prepared in previous steps within the current `Entrypoint`.\n * Returns all exports that were requested in `only`.\n */\n// eslint-disable-next-line require-yield\nexport function* evalFile(\n  this: IEvalAction\n): SyncScenarioForAction<IEvalAction> {\n  const { entrypoint } = this;\n  const { log } = entrypoint;\n\n  log(`>> evaluate __wywPreval`);\n\n  let evaluated: IEvaluateResult | undefined;\n\n  while (evaluated === undefined) {\n    try {\n      evaluated = evaluate(this.services, entrypoint);\n    } catch (e) {\n      if (isUnprocessedEntrypointError(e)) {\n        entrypoint.log(\n          'Evaluation has been aborted because one if the required files is not processed. Schedule reprocessing and repeat evaluation.'\n        );\n        yield ['processEntrypoint', e.entrypoint, undefined];\n      } else {\n        throw e;\n      }\n    }\n  }\n\n  const wywPreval = hasWywPreval(evaluated.value)\n    ? evaluated.value.__wywPreval\n    : undefined;\n\n  if (!wywPreval) {\n    return null;\n  }\n\n  const valueCache: ValueCache = new Map();\n  Object.entries(wywPreval).forEach(([key, lazyValue]) => {\n    const value = wrap(lazyValue);\n    valueCache.set(key, value);\n  });\n\n  log(`<< evaluated __wywPreval %O`, valueCache);\n\n  return [valueCache, evaluated.dependencies];\n}\n"],"mappings":";;;;;;AAGA,IAAAA,WAAA,GAAAC,sBAAA,CAAAC,OAAA;AACA,IAAAC,aAAA,GAAAF,sBAAA,CAAAC,OAAA;AACA,IAAAE,2BAAA,GAAAF,OAAA;AAAqF,SAAAD,uBAAAI,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAGrF,MAAMG,IAAI,GAAOC,EAAW,IAAgB;EAC1C,IAAI;IACF,OAAOA,EAAE,CAAC,CAAC;EACb,CAAC,CAAC,OAAOC,CAAC,EAAE;IACV,OAAOA,CAAC;EACV;AACF,CAAC;;AAED;AACA;AACA;AACA;AACA;AACO,UAAUC,QAAQA,CAAA,EAEa;EACpC,MAAM;IAAEC;EAAW,CAAC,GAAG,IAAI;EAC3B,MAAM;IAAEC;EAAI,CAAC,GAAGD,UAAU;EAE1BC,GAAG,CAAE,yBAAwB,CAAC;EAE9B,IAAIC,SAAsC;EAE1C,OAAOA,SAAS,KAAKC,SAAS,EAAE;IAC9B,IAAI;MACFD,SAAS,GAAG,IAAAE,mBAAQ,EAAC,IAAI,CAACC,QAAQ,EAAEL,UAAU,CAAC;IACjD,CAAC,CAAC,OAAOF,CAAC,EAAE;MACV,IAAI,IAAAQ,wDAA4B,EAACR,CAAC,CAAC,EAAE;QACnCE,UAAU,CAACC,GAAG,CACZ,8HACF,CAAC;QACD,MAAM,CAAC,mBAAmB,EAAEH,CAAC,CAACE,UAAU,EAAEG,SAAS,CAAC;MACtD,CAAC,MAAM;QACL,MAAML,CAAC;MACT;IACF;EACF;EAEA,MAAMS,SAAS,GAAG,IAAAC,qBAAY,EAACN,SAAS,CAACO,KAAK,CAAC,GAC3CP,SAAS,CAACO,KAAK,CAACC,WAAW,GAC3BP,SAAS;EAEb,IAAI,CAACI,SAAS,EAAE;IACd,OAAO,IAAI;EACb;EAEA,MAAMI,UAAsB,GAAG,IAAIC,GAAG,CAAC,CAAC;EACxCC,MAAM,CAACC,OAAO,CAACP,SAAS,CAAC,CAACQ,OAAO,CAAC,CAAC,CAACC,GAAG,EAAEC,SAAS,CAAC,KAAK;IACtD,MAAMR,KAAK,GAAGb,IAAI,CAACqB,SAAS,CAAC;IAC7BN,UAAU,CAACO,GAAG,CAACF,GAAG,EAAEP,KAAK,CAAC;EAC5B,CAAC,CAAC;EAEFR,GAAG,CAAE,6BAA4B,EAAEU,UAAU,CAAC;EAE9C,OAAO,CAACA,UAAU,EAAET,SAAS,CAACiB,YAAY,CAAC;AAC7C"}