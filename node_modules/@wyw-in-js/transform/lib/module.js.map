{"version":3,"file":"module.js","names":["_fs","_interopRequireDefault","require","_module","_path","_vm","_tsInvariant","_shared","_Entrypoint","_Entrypoint2","_UnprocessedEntrypointError","_createVmContext","obj","__esModule","default","DefaultModuleImplementation","exports","NativeModule","builtins","assert","buffer","child_process","cluster","console","constants","crypto","dgram","dns","domain","events","fs","http","https","module","net","os","path","punycode","process","querystring","readline","repl","stream","string_decoder","sys","timers","tls","tty","url","util","vm","zlib","NOOP","getUncached","cached","test","cachedSet","Set","split","has","filter","t","resolve","id","resolved","resolveDependency","invariant","Module","callstack","isEvaluated","Object","assign","debug","dependency","isAbsolute","Error","source","dependencies","push","entrypoint","getEntrypoint","only","evaluated","isSuperSet","evaluatedOnly","m","createChild","evaluate","ensure","bind","entrypointRef","constructor","services","parentModule","moduleImpl","_parentModule$ignored","_entrypoint$ignored","cache","isFeatureEnabled","options","pluginOptions","features","name","WeakRef","idx","filename","log","extend","parentIsIgnored","ignored","extensions","value","deref","assertTransformed","get","evaluatedCreated","supersededWith","add","createEvaluated","transformedCode","JSON","parse","context","teardown","createVmContext","__wyw_dynamic_import","__dirname","dirname","overrideContext","script","Script","runInContext","e","isUnprocessedEntrypointError","EvalError","message","join","_entrypoint$evaluated","extension","extname","includes","newEntrypoint","readFileSync","stack","getStack","_entrypoint$only","uncachedExports","length","code","Entrypoint","createRoot","getDependency","Promise","_extensions","added","forEach","ext","_resolveFilename","paths","_nodeModulePaths"],"sources":["../src/module.ts"],"sourcesContent":["/**\n * This is a custom implementation for the module system for evaluating code,\n * used for resolving values for dependencies interpolated in `css` or `styled`.\n *\n * This serves 2 purposes:\n * - Avoid leakage from evaluated code to module cache in current context, e.g. `babel-register`\n * - Allow us to invalidate the module cache without affecting other stuff, necessary for rebuilds\n *\n * We also use it to transpile the code with Babel by default.\n * We also store source maps for it to provide correct error stacktraces.\n *\n */\n\nimport fs from 'fs';\nimport NativeModule from 'module';\nimport path from 'path';\nimport vm from 'vm';\n\nimport { invariant } from 'ts-invariant';\n\nimport { isFeatureEnabled, type Debugger } from '@wyw-in-js/shared';\n\nimport './utils/dispose-polyfill';\nimport type { TransformCacheCollection } from './cache';\nimport { Entrypoint } from './transform/Entrypoint';\nimport { getStack, isSuperSet } from './transform/Entrypoint.helpers';\nimport type { IEntrypointDependency } from './transform/Entrypoint.types';\nimport type { IEvaluatedEntrypoint } from './transform/EvaluatedEntrypoint';\nimport { isUnprocessedEntrypointError } from './transform/actions/UnprocessedEntrypointError';\nimport type { Services } from './transform/types';\nimport { createVmContext } from './vm/createVmContext';\n\ntype HiddenModuleMembers = {\n  _extensions: Record<string, () => void>;\n  _resolveFilename: (\n    id: string,\n    options: { filename: string; id: string; paths: string[] }\n  ) => string;\n  _nodeModulePaths(filename: string): string[];\n};\n\nexport const DefaultModuleImplementation = NativeModule as typeof NativeModule &\n  HiddenModuleMembers;\n\n// Supported node builtins based on the modules polyfilled by webpack\n// `true` means module is polyfilled, `false` means module is empty\nconst builtins = {\n  assert: true,\n  buffer: true,\n  child_process: false,\n  cluster: false,\n  console: true,\n  constants: true,\n  crypto: true,\n  dgram: false,\n  dns: false,\n  domain: true,\n  events: true,\n  fs: false,\n  http: true,\n  https: true,\n  module: false,\n  net: false,\n  os: true,\n  path: true,\n  punycode: true,\n  process: true,\n  querystring: true,\n  readline: false,\n  repl: false,\n  stream: true,\n  string_decoder: true,\n  sys: true,\n  timers: true,\n  tls: false,\n  tty: true,\n  url: true,\n  util: true,\n  vm: true,\n  zlib: true,\n};\n\nconst NOOP = () => {};\n\nfunction getUncached(cached: string | string[], test: string[]): string[] {\n  const cachedSet = new Set(\n    typeof cached === 'string' ? cached.split(',') : cached\n  );\n\n  if (cachedSet.has('*')) {\n    return [];\n  }\n\n  return test.filter((t) => !cachedSet.has(t));\n}\n\nfunction resolve(\n  this: { resolveDependency: (id: string) => IEntrypointDependency },\n  id: string\n): string {\n  const { resolved } = this.resolveDependency(id);\n  invariant(resolved, `Unable to resolve \"${id}\"`);\n  return resolved;\n}\n\nexport class Module {\n  public readonly callstack: string[] = [];\n\n  public readonly debug: Debugger;\n\n  public readonly dependencies: string[];\n\n  public readonly extensions: string[];\n\n  public readonly filename: string;\n\n  public id: string;\n\n  public readonly idx: string;\n\n  public readonly ignored: boolean;\n\n  public isEvaluated: boolean = false;\n\n  public readonly parentIsIgnored: boolean;\n\n  public require: {\n    (id: string): unknown;\n    ensure: () => void;\n    resolve: (id: string) => string;\n  } = Object.assign(\n    (id: string) => {\n      if (id in builtins) {\n        // The module is in the allowed list of builtin node modules\n        // Ideally we should prevent importing them, but webpack polyfills some\n        // So we check for the list of polyfills to determine which ones to support\n        if (builtins[id as keyof typeof builtins]) {\n          this.debug('require', `builtin '${id}'`);\n          return require(id);\n        }\n\n        return null;\n      }\n\n      // Resolve module id (and filename) relatively to parent module\n      const dependency = this.resolveDependency(id);\n      if (dependency.resolved === id && !path.isAbsolute(id)) {\n        // The module is a builtin node modules, but not in the allowed list\n        throw new Error(\n          `Unable to import \"${id}\". Importing Node builtins is not supported in the sandbox.`\n        );\n      }\n\n      invariant(\n        dependency.resolved,\n        `Dependency ${dependency.source} cannot be resolved`\n      );\n\n      this.dependencies.push(id);\n\n      this.debug('require', `${id} -> ${dependency.resolved}`);\n\n      const entrypoint = this.getEntrypoint(\n        dependency.resolved,\n        dependency.only,\n        this.debug\n      );\n\n      if (entrypoint === null) {\n        return dependency.resolved;\n      }\n\n      if (\n        entrypoint.evaluated ||\n        isSuperSet(entrypoint.evaluatedOnly, dependency.only)\n      ) {\n        return entrypoint.exports;\n      }\n\n      const m = this.createChild(entrypoint);\n      m.evaluate();\n\n      return entrypoint.exports;\n    },\n    {\n      ensure: NOOP,\n      resolve: resolve.bind(this),\n    }\n  );\n\n  public resolve = resolve.bind(this);\n\n  private cache: TransformCacheCollection;\n\n  #entrypointRef: WeakRef<Entrypoint> | Entrypoint;\n\n  constructor(\n    private services: Services,\n    entrypoint: Entrypoint,\n    parentModule?: Module,\n    private moduleImpl: HiddenModuleMembers = DefaultModuleImplementation\n  ) {\n    this.cache = services.cache;\n    this.#entrypointRef = isFeatureEnabled(\n      services.options.pluginOptions.features,\n      'useWeakRefInEval',\n      entrypoint.name\n    )\n      ? new WeakRef(entrypoint)\n      : entrypoint;\n    this.idx = entrypoint.idx;\n    this.id = entrypoint.name;\n    this.filename = entrypoint.name;\n    this.dependencies = [];\n    this.debug = entrypoint.log.extend('module');\n    this.parentIsIgnored = parentModule?.ignored ?? false;\n    this.ignored = entrypoint.ignored ?? this.parentIsIgnored;\n\n    if (parentModule) {\n      this.callstack = [entrypoint.name, ...parentModule.callstack];\n    } else {\n      this.callstack = [entrypoint.name];\n    }\n\n    this.extensions = services.options.pluginOptions.extensions;\n\n    this.debug('init', entrypoint.name);\n  }\n\n  public get exports() {\n    return this.entrypoint.exports;\n  }\n\n  public set exports(value) {\n    this.entrypoint.exports = value;\n\n    this.debug('the whole exports was overridden with %O', value);\n  }\n\n  protected get entrypoint(): Entrypoint {\n    const entrypoint =\n      this.#entrypointRef instanceof WeakRef\n        ? this.#entrypointRef.deref()\n        : this.#entrypointRef;\n    invariant(entrypoint, `Module ${this.idx} is disposed`);\n    return entrypoint;\n  }\n\n  evaluate(): void {\n    const { entrypoint } = this;\n    entrypoint.assertTransformed();\n\n    const cached = this.cache.get('entrypoints', entrypoint.name)!;\n    let evaluatedCreated = false;\n    if (!entrypoint.supersededWith) {\n      this.cache.add(\n        'entrypoints',\n        entrypoint.name,\n        entrypoint.createEvaluated()\n      );\n      evaluatedCreated = true;\n    }\n\n    const { transformedCode: source } = entrypoint;\n    const { pluginOptions } = this.services.options;\n\n    if (!source) {\n      this.debug(`evaluate`, 'there is nothing to evaluate');\n      return;\n    }\n\n    if (this.isEvaluated) {\n      this.debug('evaluate', `is already evaluated`);\n      return;\n    }\n\n    this.debug('evaluate');\n    this.debug.extend('source')('%s', source);\n\n    this.isEvaluated = true;\n\n    const { filename } = this;\n\n    if (/\\.json$/.test(filename)) {\n      // For JSON files, parse it to a JS object similar to Node\n      this.exports = JSON.parse(source);\n      return;\n    }\n\n    const { context, teardown } = createVmContext(\n      filename,\n      pluginOptions.features,\n      {\n        module: this,\n        exports: entrypoint.exports,\n        require: this.require,\n        __wyw_dynamic_import: async (id: string) => this.require(id),\n        __dirname: path.dirname(filename),\n      },\n      pluginOptions.overrideContext\n    );\n\n    try {\n      const script = new vm.Script(\n        `(function (exports) { ${source}\\n})(exports);`,\n        {\n          filename,\n        }\n      );\n\n      script.runInContext(context);\n    } catch (e) {\n      this.isEvaluated = false;\n      if (evaluatedCreated) {\n        this.cache.add('entrypoints', entrypoint.name, cached);\n      }\n\n      if (isUnprocessedEntrypointError(e)) {\n        // It will be handled by evalFile scenario\n        throw e;\n      }\n\n      if (e instanceof EvalError) {\n        this.debug('%O', e);\n\n        throw e;\n      }\n\n      this.debug('%O\\n%O', e, this.callstack);\n      throw new EvalError(\n        `${(e as Error).message} in${this.callstack.join('\\n| ')}\\n`\n      );\n    } finally {\n      teardown();\n    }\n  }\n\n  getEntrypoint(\n    filename: string,\n    only: string[],\n    log: Debugger\n  ): Entrypoint | IEvaluatedEntrypoint | null {\n    const extension = path.extname(filename);\n    if (extension !== '.json' && !this.extensions.includes(extension)) {\n      return null;\n    }\n\n    const entrypoint = this.cache.get('entrypoints', filename);\n    if (entrypoint && isSuperSet(entrypoint.evaluatedOnly ?? [], only)) {\n      log('✅ file has been already evaluated');\n      return entrypoint;\n    }\n\n    if (entrypoint?.ignored) {\n      log(\n        '✅ file has been ignored during prepare stage. Original code will be used'\n      );\n      return entrypoint;\n    }\n\n    if (this.ignored) {\n      log(\n        '✅ one of the parent files has been ignored during prepare stage. Original code will be used'\n      );\n\n      const newEntrypoint = this.entrypoint.createChild(\n        filename,\n        ['*'],\n        fs.readFileSync(filename, 'utf-8')\n      );\n\n      if (newEntrypoint === 'loop') {\n        const stack = getStack(this.entrypoint);\n        throw new Error(\n          `Circular dependency detected: ${stack.join(' -> ')} -> ${filename}`\n        );\n      }\n\n      return newEntrypoint;\n    }\n\n    // Requested file can be already prepared for evaluation on the stage 1\n    if (only && entrypoint) {\n      const uncachedExports = getUncached(entrypoint.only ?? [], only);\n      if (uncachedExports.length === 0) {\n        log('✅ ready for evaluation');\n        return entrypoint;\n      }\n\n      log(\n        '❌ file has been processed during prepare stage but %o is not evaluated yet (evaluated: %o)',\n        uncachedExports,\n        entrypoint.only\n      );\n    } else {\n      log('❌ file has not been processed during prepare stage');\n    }\n\n    // If code wasn't extracted from cache, it indicates that we were unable\n    // to process some of the imports on stage1. Let's try to reprocess.\n    const code = fs.readFileSync(filename, 'utf-8');\n    const newEntrypoint = Entrypoint.createRoot(\n      this.services,\n      filename,\n      only,\n      code\n    );\n\n    if (newEntrypoint.evaluated) {\n      log('✅ file has been already evaluated');\n      return newEntrypoint;\n    }\n\n    if (newEntrypoint.ignored) {\n      log(\n        '✅ file has been ignored during prepare stage. Original code will be used'\n      );\n      return newEntrypoint;\n    }\n\n    return newEntrypoint;\n  }\n\n  resolveDependency = (id: string): IEntrypointDependency => {\n    const cached = this.entrypoint.getDependency(id);\n    invariant(!(cached instanceof Promise), 'Dependency is not resolved yet');\n\n    if (cached) {\n      return cached;\n    }\n\n    if (!this.ignored) {\n      this.debug(\n        '❌ import has not been resolved during prepare stage. Fallback to Node.js resolver'\n      );\n    }\n\n    const extensions = this.moduleImpl._extensions;\n    const added: string[] = [];\n\n    try {\n      // Check for supported extensions\n      this.extensions.forEach((ext) => {\n        if (ext in extensions) {\n          return;\n        }\n\n        // When an extension is not supported, add it\n        // And keep track of it to clean it up after resolving\n        // Use noop for the transform function since we handle it\n        extensions[ext] = NOOP;\n        added.push(ext);\n      });\n\n      const { filename } = this;\n\n      const resolved = this.moduleImpl._resolveFilename(id, {\n        id: filename,\n        filename,\n        paths: this.moduleImpl._nodeModulePaths(path.dirname(filename)),\n      });\n\n      return {\n        source: id,\n        only: ['*'],\n        resolved,\n      };\n    } finally {\n      // Cleanup the extensions we added to restore previous behaviour\n      added.forEach((ext) => delete extensions[ext]);\n    }\n  };\n\n  protected createChild(entrypoint: Entrypoint): Module {\n    return new Module(this.services, entrypoint, this, this.moduleImpl);\n  }\n}\n"],"mappings":"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"}