{"version":3,"file":"collector.js","names":["_shared","require","_EventEmitter","_getTagProcessor","_scopeHelpers","_traversalCache","filename","exports","__filename","collector","file","options","values","_options$eventEmitter","_file$path$scope$getD","eventEmitter","EventEmitter","dummy","processors","perf","applyProcessors","path","opts","processor","build","doRuntimeReplacement","push","length","prevalExport","scope","getData","findParent","p","isExpressionStatement","removeWithRelated","collectorPlugin","babel","_options$values","Map","debug","logger","extend","name","pre","metadata","wywInJS","replacements","rules","dependencies","visitor","post","invalidateTraversalCache"],"sources":["../../src/plugins/collector.ts"],"sourcesContent":["/**\n * Collector traverses the AST and collects information about imports and\n * all usages of WYW-processors.\n */\n\nimport type { BabelFile, PluginObj } from '@babel/core';\nimport type { NodePath } from '@babel/traverse';\n\nimport type { ValueCache } from '@wyw-in-js/processor-utils';\nimport { logger } from '@wyw-in-js/shared';\nimport type { StrictOptions } from '@wyw-in-js/shared';\n\nimport { EventEmitter } from '../utils/EventEmitter';\nimport { applyProcessors } from '../utils/getTagProcessor';\nimport type { Core } from '../babel';\nimport type { IPluginState } from '../types';\nimport type { WYWTransformMetadata } from '../utils/TransformMetadata';\nimport { removeWithRelated } from '../utils/scopeHelpers';\nimport { invalidateTraversalCache } from '../utils/traversalCache';\n\nexport const filename = __filename;\n\nexport function collector(\n  file: BabelFile,\n  options: Pick<\n    StrictOptions,\n    'classNameSlug' | 'displayName' | 'extensions' | 'evaluate' | 'tagResolver'\n  > & { eventEmitter?: EventEmitter },\n  values: ValueCache\n) {\n  const eventEmitter = options.eventEmitter ?? EventEmitter.dummy;\n  const processors: WYWTransformMetadata['processors'] = [];\n\n  eventEmitter.perf('transform:collector:processTemplate', () => {\n    applyProcessors(file.path, file.opts, options, (processor) => {\n      processor.build(values);\n      processor.doRuntimeReplacement();\n      processors.push(processor);\n    });\n  });\n\n  if (processors.length === 0) {\n    // We didn't find any processors.\n    return processors;\n  }\n\n  // We can remove __wywPreval export and all related code\n  const prevalExport = (\n    file.path.scope.getData('__wywPreval') as NodePath | undefined\n  )?.findParent((p) => p.isExpressionStatement());\n  if (prevalExport) {\n    removeWithRelated([prevalExport]);\n  }\n\n  return processors;\n}\n\nexport default function collectorPlugin(\n  babel: Core,\n  options: StrictOptions & { eventEmitter?: EventEmitter; values?: ValueCache }\n): PluginObj<IPluginState> {\n  const values = options.values ?? new Map<string, unknown>();\n  const debug = logger.extend('collector');\n  return {\n    name: '@wyw-in-js/transform/collector',\n    pre(file: BabelFile) {\n      debug('start %s', file.opts.filename);\n\n      const processors = collector(file, options, values);\n\n      if (processors.length === 0) {\n        // We didn't find any wyw-in-js template literals.\n        return;\n      }\n\n      this.file.metadata.wywInJS = {\n        processors,\n        replacements: [],\n        rules: {},\n        dependencies: [],\n      };\n\n      debug('end %s', file.opts.filename);\n    },\n    visitor: {},\n    post(file: BabelFile) {\n      invalidateTraversalCache(file.path);\n    },\n  };\n}\n"],"mappings":";;;;;;;;AASA,IAAAA,OAAA,GAAAC,OAAA;AAGA,IAAAC,aAAA,GAAAD,OAAA;AACA,IAAAE,gBAAA,GAAAF,OAAA;AAIA,IAAAG,aAAA,GAAAH,OAAA;AACA,IAAAI,eAAA,GAAAJ,OAAA;AAlBA;AACA;AACA;AACA;;AAiBO,MAAMK,QAAQ,GAAAC,OAAA,CAAAD,QAAA,GAAGE,UAAU;AAE3B,SAASC,SAASA,CACvBC,IAAe,EACfC,OAGmC,EACnCC,MAAkB,EAClB;EAAA,IAAAC,qBAAA,EAAAC,qBAAA;EACA,MAAMC,YAAY,IAAAF,qBAAA,GAAGF,OAAO,CAACI,YAAY,cAAAF,qBAAA,cAAAA,qBAAA,GAAIG,0BAAY,CAACC,KAAK;EAC/D,MAAMC,UAA8C,GAAG,EAAE;EAEzDH,YAAY,CAACI,IAAI,CAAC,qCAAqC,EAAE,MAAM;IAC7D,IAAAC,gCAAe,EAACV,IAAI,CAACW,IAAI,EAAEX,IAAI,CAACY,IAAI,EAAEX,OAAO,EAAGY,SAAS,IAAK;MAC5DA,SAAS,CAACC,KAAK,CAACZ,MAAM,CAAC;MACvBW,SAAS,CAACE,oBAAoB,CAAC,CAAC;MAChCP,UAAU,CAACQ,IAAI,CAACH,SAAS,CAAC;IAC5B,CAAC,CAAC;EACJ,CAAC,CAAC;EAEF,IAAIL,UAAU,CAACS,MAAM,KAAK,CAAC,EAAE;IAC3B;IACA,OAAOT,UAAU;EACnB;;EAEA;EACA,MAAMU,YAAY,IAAAd,qBAAA,GAChBJ,IAAI,CAACW,IAAI,CAACQ,KAAK,CAACC,OAAO,CAAC,aAAa,CAAC,cAAAhB,qBAAA,uBADnBA,qBAAA,CAElBiB,UAAU,CAAEC,CAAC,IAAKA,CAAC,CAACC,qBAAqB,CAAC,CAAC,CAAC;EAC/C,IAAIL,YAAY,EAAE;IAChB,IAAAM,+BAAiB,EAAC,CAACN,YAAY,CAAC,CAAC;EACnC;EAEA,OAAOV,UAAU;AACnB;AAEe,SAASiB,eAAeA,CACrCC,KAAW,EACXzB,OAA6E,EACpD;EAAA,IAAA0B,eAAA;EACzB,MAAMzB,MAAM,IAAAyB,eAAA,GAAG1B,OAAO,CAACC,MAAM,cAAAyB,eAAA,cAAAA,eAAA,GAAI,IAAIC,GAAG,CAAkB,CAAC;EAC3D,MAAMC,KAAK,GAAGC,cAAM,CAACC,MAAM,CAAC,WAAW,CAAC;EACxC,OAAO;IACLC,IAAI,EAAE,gCAAgC;IACtCC,GAAGA,CAACjC,IAAe,EAAE;MACnB6B,KAAK,CAAC,UAAU,EAAE7B,IAAI,CAACY,IAAI,CAAChB,QAAQ,CAAC;MAErC,MAAMY,UAAU,GAAGT,SAAS,CAACC,IAAI,EAAEC,OAAO,EAAEC,MAAM,CAAC;MAEnD,IAAIM,UAAU,CAACS,MAAM,KAAK,CAAC,EAAE;QAC3B;QACA;MACF;MAEA,IAAI,CAACjB,IAAI,CAACkC,QAAQ,CAACC,OAAO,GAAG;QAC3B3B,UAAU;QACV4B,YAAY,EAAE,EAAE;QAChBC,KAAK,EAAE,CAAC,CAAC;QACTC,YAAY,EAAE;MAChB,CAAC;MAEDT,KAAK,CAAC,QAAQ,EAAE7B,IAAI,CAACY,IAAI,CAAChB,QAAQ,CAAC;IACrC,CAAC;IACD2C,OAAO,EAAE,CAAC,CAAC;IACXC,IAAIA,CAACxC,IAAe,EAAE;MACpB,IAAAyC,wCAAwB,EAACzC,IAAI,CAACW,IAAI,CAAC;IACrC;EACF,CAAC;AACH"}