{"version":3,"file":"shaker.js","names":["_ShakerMetadata","require","_getPluginKey","hasKeyInList","plugin","list","pluginKey","getPluginKey","some","i","includes","safeResolve","id","paths","resolve","filter","shaker","evalConfig","ast","code","highPriorityPlugins","config","babel","_evalConfig$plugins$f","_evalConfig$plugins","_evalConfig$plugins2","_evalConfig$plugins3","_evalConfig$filename","_evalConfig$filename2","_transformed$code","preShakePlugins","plugins","hasCommonjsPlugin","push","filename","endsWith","_evalConfig$plugins4","hasTypescriptPlugin","preset","transformOptions","caller","name","transformed","transformFromAstSync","hasShakerMetadata","metadata","Error","wywEvaluator","imports","exports","_default","default"],"sources":["../src/shaker.ts"],"sourcesContent":["import type { TransformOptions, PluginItem } from '@babel/core';\n\nimport type { Evaluator } from '@wyw-in-js/shared';\n\nimport { hasShakerMetadata } from './utils/ShakerMetadata';\nimport { getPluginKey } from './utils/getPluginKey';\n\nconst hasKeyInList = (plugin: PluginItem, list: string[]): boolean => {\n  const pluginKey = getPluginKey(plugin);\n  return pluginKey ? list.some((i) => pluginKey.includes(i)) : false;\n};\n\nconst safeResolve = (id: string, paths: (string | null)[]): string | null => {\n  try {\n    return require.resolve(id, {\n      paths: paths.filter((i) => i !== null) as string[],\n    });\n  } catch {\n    return null;\n  }\n};\n\nexport const shaker: Evaluator = (\n  evalConfig,\n  ast,\n  code,\n  { highPriorityPlugins, ...config },\n  babel\n) => {\n  const preShakePlugins =\n    evalConfig.plugins?.filter((i) => hasKeyInList(i, highPriorityPlugins)) ??\n    [];\n\n  const plugins = [\n    ...preShakePlugins,\n    [require.resolve('./plugins/shaker'), config],\n    ...(evalConfig.plugins ?? []).filter(\n      (i) => !hasKeyInList(i, highPriorityPlugins)\n    ),\n  ];\n\n  const hasCommonjsPlugin = evalConfig.plugins?.some(\n    (i) => getPluginKey(i) === 'transform-modules-commonjs'\n  );\n\n  if (!hasCommonjsPlugin) {\n    plugins.push(require.resolve('@babel/plugin-transform-modules-commonjs'));\n  }\n\n  if (\n    evalConfig.filename?.endsWith('.ts') ||\n    evalConfig.filename?.endsWith('.tsx')\n  ) {\n    const hasTypescriptPlugin = evalConfig.plugins?.some(\n      (i) => getPluginKey(i) === 'transform-typescript'\n    );\n\n    if (!hasTypescriptPlugin) {\n      const preset = safeResolve('@babel/preset-typescript', [\n        evalConfig.filename,\n      ]);\n      const plugin = safeResolve('@babel/plugin-transform-typescript', [\n        evalConfig.filename,\n        preset,\n      ]);\n\n      if (plugin) {\n        plugins.push(plugin);\n      }\n    }\n  }\n\n  const transformOptions: TransformOptions = {\n    ...evalConfig,\n    caller: {\n      name: 'wyw-in-js',\n    },\n    plugins,\n  };\n\n  const transformed = babel.transformFromAstSync(ast, code, transformOptions);\n\n  if (!transformed || !hasShakerMetadata(transformed.metadata)) {\n    throw new Error(`${evalConfig.filename} has no shaker metadata`);\n  }\n\n  return [\n    transformed.ast!,\n    transformed.code ?? '',\n    transformed.metadata.wywEvaluator.imports,\n  ];\n};\n\nexport default shaker;\n"],"mappings":"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"}